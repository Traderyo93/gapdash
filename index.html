<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequitas Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1d2e;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #252836;
            border-radius: 8px;
            align-items: center;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(66, 153, 225, 0.2);
            border-radius: 20px;
            border: 1px solid #4299e1;
        }

        .filter-label {
            color: #a0aec0;
            font-weight: 500;
        }

        .filter-value {
            color: #4299e1;
            font-weight: 600;
        }

        .top-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-section {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .stat-header .info-icon {
            width: 16px;
            height: 16px;
            border: 1px solid #8b8fa3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
        }

        .time-filter {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .time-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .time-btn.active {
            background: #4299e1;
        }

        .time-btn:hover {
            background: #5a6578;
        }

        .time-btn.active:hover {
            background: #3182ce;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        /* Monthly Charts Section */
        .monthly-charts-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .monthly-charts-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .period-selector {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .period-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .period-btn.active {
            background: #4299e1;
        }

        .period-btn:hover {
            background: #5a6578;
        }

        .period-btn.active:hover {
            background: #3182ce;
        }

        .monthly-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .monthly-chart-item {
            background: #1a1d2e;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .monthly-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .monthly-chart-title {
            color: #4299e1;
            font-weight: 700;
            font-size: 14px;
        }

        .monthly-chart-stats {
            color: #8b8fa3;
            font-size: 11px;
            text-align: right;
        }

        .monthly-chart-container {
            height: 120px;
            position: relative;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day.has-gaps {
            background: #4299e1;
            color: white;
        }

        .calendar-day.no-gaps {
            background: #2d3748;
            color: #8b8fa3;
        }

        .calendar-day.weekend {
            background: #1a1d2e;
            color: #4a5568;
        }

        .calendar-day:hover {
            transform: scale(1.1);
        }

        .date-info {
            text-align: right;
            margin-bottom: 15px;
        }

        .date-info .date {
            color: #4299e1;
            font-weight: 600;
        }

        .date-info .days-since {
            color: #8b8fa3;
            font-size: 12px;
        }

        .gaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .gap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1d2e;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .gap-item:hover {
            background: #2d3748;
        }

        .gap-ticker {
            font-weight: 600;
            color: #ffffff;
        }

        .gap-percentage {
            font-weight: 600;
        }

        .gap-positive {
            color: #48bb78;
        }

        .gap-negative {
            color: #f56565;
        }

        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4299e1;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn:hover {
            background: #3182ce;
        }

        .logout-section {
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 10px;
            cursor: pointer;
        }

        .logout-section:hover {
            color: #fed7d7;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b8fa3;
        }

        /* Individual Chart Modal */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .chart-modal-content {
            background: #252836;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-modal-title {
            color: #4299e1;
            font-size: 18px;
            font-weight: 700;
        }

        .chart-modal-close {
            background: none;
            border: none;
            color: #8b8fa3;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .chart-modal-close:hover {
            color: #ffffff;
        }

        .chart-modal-body {
            height: 400px;
            position: relative;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .top-stats {
                grid-template-columns: 1fr;
            }

            .monthly-charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        /* Custom scrollbar */
        .gaps-list::-webkit-scrollbar, .monthly-charts-grid::-webkit-scrollbar {
            width: 6px;
        }

        .gaps-list::-webkit-scrollbar-track, .monthly-charts-grid::-webkit-scrollbar-track {
            background: #1a1d2e;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb, .monthly-charts-grid::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb:hover, .monthly-charts-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }
    </style>
</head>

<body>
    <div class="refresh-btn" id="refreshBtn">
        <span onclick="loadData()">🔄 Refresh</span>
        <span class="logout-section" onclick="logout()">👤 <span id="usernameDisplay">User</span> | Logout</span>
    </div>

    <div class="dashboard-container">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-item">
                <span class="filter-label">Gap value between</span>
                <span class="filter-value">45% and 1000%</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Volume greater than</span>
                <span class="filter-value">1.00 M</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Price greater than</span>
                <span class="filter-value">$0.30</span>
            </div>
        </div>

        <!-- Top Statistics Section -->
        <div class="top-stats">
            <!-- Gappers Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Gappers</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="gappers">D</button>
                        <button class="time-btn" data-period="W" data-chart="gappers">W</button>
                        <button class="time-btn active" data-period="M" data-chart="gappers">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gappersChart"></canvas>
                </div>
            </div>

            <!-- Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Volume</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="volume">D</button>
                        <button class="time-btn" data-period="W" data-chart="volume">W</button>
                        <button class="time-btn active" data-period="M" data-chart="volume">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Dollar Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>$ volume</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="dollar">D</button>
                        <button class="time-btn" data-period="W" data-chart="dollar">W</button>
                        <button class="time-btn active" data-period="M" data-chart="dollar">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dollarVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Monthly Average Charts -->
                <div class="monthly-charts-card">
                    <div class="monthly-charts-header">
                        <span>Average change from open</span>
                        <div class="info-icon">?</div>
                        <div class="period-selector">
                            <button class="period-btn" data-period="D">D</button>
                            <button class="period-btn" data-period="W">W</button>
                            <button class="period-btn active" data-period="M">M</button>
                        </div>
                    </div>
                    <div class="monthly-charts-grid" id="monthlyChartsGrid">
                        <!-- Monthly average charts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Calendar -->
                <div class="sidebar-card">
                    <div class="date-info">
                        <div class="date" id="currentDate">2025-06-23</div>
                        <div class="days-since" id="daysSince">3 days</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Last Gaps -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <span>Recent gaps</span>
                        <div class="info-icon">?</div>
                    </div>
                    <div class="gaps-list" id="gapsList">
                        <!-- Gap items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Chart Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <div class="chart-modal-title" id="modalChartTitle">Individual Chart</div>
                <button class="chart-modal-close" onclick="closeIndividualChart()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <canvas id="individualChart"></canvas>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
        Loading dashboard data...
    </div>
    <script>
        // ===== AUTHENTICATION SYSTEM =====
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                window.location.href = '/login.html';
                return false;
            }
            
            return true;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }

        // Check authentication immediately
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }

        // ===== DASHBOARD CODE =====
        let dashboardData = null;
        let chartInstances = {};
        let currentTopChartPeriods = { gappers: 'M', volume: 'M', dollar: 'M' };
        let currentBottomPeriod = 'M';

        async function loadData() {
            const loadingEl = document.getElementById('loadingIndicator');
            
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('./data/gap_data_cache.json');
                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                const rawData = await response.json();
                dashboardData = processGapDataCache(rawData);
                updateDashboard();

                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use demo data
                dashboardData = generateDemoData();
                updateDashboard();
                loadingEl.style.display = 'none';
            }
        }

        function processGapDataCache(rawData) {
            console.log('Processing complete gap data cache...');
            console.log(`Found ${rawData.totalGappers} total gappers`);
            console.log(`Found ${Object.keys(rawData.monthlyAverages || {}).length} monthly averages`);

            return {
                monthlyAverages: rawData.monthlyAverages || {},
                monthlyStats: rawData.monthlyStats || [],
                weeklyStats: rawData.weeklyStats || [],
                calendarData: rawData.calendarData || {},
                lastGaps: rawData.lastGaps || [],
                summaryStats: rawData.summaryStats || {},
                totalGappers: rawData.totalGappers || 0,
                lastUpdated: rawData.lastUpdated
            };
        }

        function updateDashboard() {
            updateCurrentDate();
            createTopCharts();
            createMonthlyAverageCharts();
            createCalendar(dashboardData.calendarData);
            updateLastGaps(dashboardData.lastGaps);
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toISOString().split('T')[0];
            
            const daysSince = dashboardData.calendarData?.days_since_last_gap || 0;
            document.getElementById('daysSince').textContent = `${daysSince} days`;
        }

        function createTopCharts() {
            createGappersChart();
            createVolumeChart();
            createDollarVolumeChart();
        }

        function createGappersChart() {
            const ctx = document.getElementById('gappersChart').getContext('2d');
            
            if (chartInstances.gappersChart && typeof chartInstances.gappersChart.destroy === 'function') {
                chartInstances.gappersChart.destroy();
            }

            const period = currentTopChartPeriods.gappers;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.gapper_count);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => Math.abs(w.avg_open_to_close)); // Use absolute value as proxy
            } else {
                // Daily - use last 30 days of monthly data as approximation
                const monthlyData = dashboardData.monthlyStats.slice(-6);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => Math.floor(m.gapper_count / 30)); // Daily average
            }

            chartInstances.gappersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { color: '#8b8fa3' }
                        }
                    }
                }
            });
        }

        function createVolumeChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            if (chartInstances.volumeChart && typeof chartInstances.volumeChart.destroy === 'function') {
                chartInstances.volumeChart.destroy();
            }

            const period = currentTopChartPeriods.volume;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(() => Math.random() * 50 + 10); // Demo weekly volume
            } else {
                const monthlyData = dashboardData.monthlyStats.slice(-6);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_volume / 1000000 / 30); // Daily average
            }

            chartInstances.volumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#8b8fa3',
                                callback: function(value) {
                                    return value.toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDollarVolumeChart() {
            const ctx = document.getElementById('dollarVolumeChart').getContext('2d');
            
            if (chartInstances.dollarVolumeChart && typeof chartInstances.dollarVolumeChart.destroy === 'function') {
                chartInstances.dollarVolumeChart.destroy();
            }

            const period = currentTopChartPeriods.dollar;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_dollar_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(() => Math.random() * 200 + 50); // Demo weekly dollar volume
            } else {
                const monthlyData = dashboardData.monthlyStats.slice(-6);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_dollar_volume / 1000000 / 30); // Daily average
            }

            chartInstances.dollarVolumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#8b8fa3',
                                callback: function(value) {
                                    return '$' + value.toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyAverageCharts() {
            const chartsGrid = document.getElementById('monthlyChartsGrid');
            chartsGrid.innerHTML = '';
            
            // Clear existing monthly chart instances
            Object.keys(chartInstances).forEach(key => {
                if (key.startsWith('monthly_') && chartInstances[key] && typeof chartInstances[key].destroy === 'function') {
                    chartInstances[key].destroy();
                    delete chartInstances[key];
                }
            });

            const monthlyAverages = dashboardData.monthlyAverages;
            
            // Sort months by date (most recent first)
            const sortedMonths = Object.keys(monthlyAverages).sort((a, b) => b.localeCompare(a));
            
            // Show last 12 months
            sortedMonths.slice(0, 12).forEach(monthKey => {
                const monthData = monthlyAverages[monthKey];
                createMonthlyChart(monthData, monthKey);
            });

            if (sortedMonths.length === 0) {
                chartsGrid.innerHTML = '<div style="text-align: center; color: #8b8fa3; padding: 40px;">No monthly average data available</div>';
            }
        }

        function createMonthlyChart(monthData, monthKey) {
            const chartsGrid = document.getElementById('monthlyChartsGrid');
            
            // Create chart container
            const chartItem = document.createElement('div');
            chartItem.className = 'monthly-chart-item';
            
            const chartId = `monthly_${monthKey.replace('-', '_')}`;
            
            chartItem.innerHTML = `
                <div class="monthly-chart-header">
                    <div class="monthly-chart-title">${monthData.month} ${monthData.year}</div>
                    <div class="monthly-chart-stats">
                        <div>${monthData.gapper_count} gappers</div>
                        <div>${monthData.avg_open_to_close > 0 ? '+' : ''}${monthData.avg_open_to_close}% avg</div>
                    </div>
                </div>
                <div class="monthly-chart-container">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;
            
            chartsGrid.appendChild(chartItem);
            
            // Create the actual chart
            setTimeout(() => {
                createMonthlyAverageChart(chartId, monthData);
            }, 10);
        }

        function createMonthlyAverageChart(chartId, monthData) {
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            
            const ctxContext = ctx.getContext('2d');
            
            const labels = monthData.time_labels || [];
            const avgPrices = monthData.avg_prices || [];
            const avgHighs = monthData.avg_highs || [];
            const avgLows = monthData.avg_lows || [];
            const openLine = monthData.open_line || [];

            const chart = new Chart(ctxContext, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'High',
                            data: avgHighs,
                            borderColor: '#48bb78',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.2
                        },
                        {
                            label: 'Price',
                            data: avgPrices,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 3,
                            tension: 0.3
                        },
                        {
                            label: 'Open',
                            data: openLine,
                            borderColor: '#fbbf24',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Low',
                            data: avgLows,
                            borderColor: '#f56565',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(37, 40, 54, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8b8fa3',
                            borderColor: '#4299e1',
                            borderWidth: 1,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return `${monthData.month} ${monthData.year} - ${context[0].label}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#8b8fa3',
                                maxTicksLimit: 4,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(139, 143, 163, 0.1)'
                            },
                            ticks: {
                                color: '#8b8fa3',
                                maxTicksLimit: 4,
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Store chart instance for cleanup
            chartInstances[chartId] = chart;
        }

        function createCalendar(calendarData) {
            const calendar = document.getElementById('calendarGrid');
            calendar.innerHTML = '';

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // Get gap dates from real data
            const gapDates = new Set(calendarData?.gap_dates || []);

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day weekend';
                calendar.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;

                const dayOfWeek = new Date(year, month, day).getDay();
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayEl.classList.add('weekend');
                } else {
                    if (gapDates.has(dateString)) {
                        dayEl.classList.add('has-gaps');
                    } else {
                        dayEl.classList.add('no-gaps');
                    }
                }

                calendar.appendChild(dayEl);
            }
        }

        function updateLastGaps(lastGaps) {
            const container = document.getElementById('gapsList');
            container.innerHTML = '';

            lastGaps.slice(0, 25).forEach(gap => {
                const gapItem = document.createElement('div');
                gapItem.className = 'gap-item';
                gapItem.onclick = () => showIndividualChart(gap);

                const isPositive = gap.gapPercentage >= 0;
                const percentageClass = isPositive ? 'gap-positive' : 'gap-negative';
                const otcClass = gap.openToCloseChange >= 0 ? 'gap-positive' : 'gap-negative';

                gapItem.innerHTML = `
                    <div>
                        <div class="gap-ticker">${gap.ticker}</div>
                        <div style="font-size: 11px; color: #8b8fa3;">${formatDate(gap.date)}</div>
                    </div>
                    <div>
                        <div class="gap-percentage ${percentageClass}">${gap.gapPercentage > 0 ? '+' : ''}${gap.gapPercentage.toFixed(1)}%</div>
                        <div class="${otcClass}" style="font-size: 11px; text-align: right;">
                            ${gap.openToCloseChange > 0 ? '+' : ''}${gap.openToCloseChange.toFixed(1)}%
                        </div>
                    </div>
                `;

                container.appendChild(gapItem);
            });
        }

        function showIndividualChart(gapData) {
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalChartTitle');
            
            modalTitle.textContent = `${gapData.ticker} - ${formatDate(gapData.date)} - ${gapData.gapPercentage > 0 ? '+' : ''}${gapData.gapPercentage.toFixed(1)}%`;
            
            modal.style.display = 'flex';
            
            // Clear existing individual chart
            if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
                chartInstances.individualChart.destroy();
            }
            
            // Create individual chart
            setTimeout(() => {
                createIndividualChart(gapData);
            }, 100);
        }

        function createIndividualChart(gapData) {
            const ctx = document.getElementById('individualChart').getContext('2d');
            
            const individualData = gapData.individualData;
            if (!individualData) {
                console.error('No individual chart data available');
                return;
            }

            const labels = individualData.time_labels || [];
            const prices = individualData.price_values || [];
            
            // Create reference lines
            const openLine = new Array(labels.length).fill(individualData.open);
            const highLine = new Array(labels.length).fill(individualData.high);
            const lowLine = new Array(labels.length).fill(individualData.low);

            chartInstances.individualChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'High',
                            data: highLine,
                            borderColor: '#48bb78',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Price',
                            data: prices,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointRadius: 1,
                            pointHoverRadius: 4,
                            tension: 0.2
                        },
                        {
                            label: 'Open',
                            data: openLine,
                            borderColor: '#fbbf24',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Low',
                            data: lowLine,
                            borderColor: '#f56565',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#8b8fa3',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(37, 40, 54, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8b8fa3',
                            borderColor: '#4299e1',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    return `${gapData.ticker} - ${context[0].label}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(139, 143, 163, 0.1)'
                            },
                            ticks: {
                                color: '#8b8fa3',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(139, 143, 163, 0.1)'
                            },
                            ticks: {
                                color: '#8b8fa3',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function closeIndividualChart() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';
            
            if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
                chartInstances.individualChart.destroy();
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function generateDemoData() {
            // Generate demo data matching the expected structure
            const monthlyAverages = {};
            const monthlyStats = [];
            const weeklyStats = [];
            const lastGaps = [];
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const now = new Date();
            
            // Generate last 12 months of data
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = monthNames[date.getMonth()];
                
                // Generate time series for average chart
                const timeLabels = [];
                const avgPrices = [];
                const avgHighs = [];
                const avgLows = [];
                const openLine = [];
                
                for (let j = 0; j < 26; j++) {
                    const hour = 9 + Math.floor(j * 0.25);
                    const minute = 30 + ((j * 15) % 60);
                    timeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                    
                    const progress = j / 25;
                    const baseChange = (Math.random() - 0.5) * 20; // -10% to +10%
                    const volatility = Math.sin(progress * Math.PI) * 5; // Peak volatility mid-day
                    
                    avgPrices.push(baseChange + (Math.random() - 0.5) * volatility);
                    avgHighs.push(baseChange + Math.abs(volatility) + Math.random() * 5);
                    avgLows.push(baseChange - Math.abs(volatility) - Math.random() * 5);
                    openLine.push(0);
                }
                
                const gapperCount = Math.floor(Math.random() * 50) + 20;
                const avgOTC = (Math.random() - 0.5) * 20;
                
                monthlyAverages[monthKey] = {
                    month: monthName,
                    year: date.getFullYear(),
                    month_key: monthKey,
                    gapper_count: gapperCount,
                    avg_gap_percentage: Math.random() * 100 + 50,
                    avg_open_to_close: avgOTC,
                    total_volume: Math.floor(Math.random() * 100000000) + 50000000,
                    total_dollar_volume: Math.floor(Math.random() * 500000000) + 100000000,
                    time_labels: timeLabels,
                    avg_prices: avgPrices,
                    avg_highs: avgHighs,
                    avg_lows: avgLows,
                    open_line: openLine
                };
                
                monthlyStats.push({
                    month: monthName,
                    year: date.getFullYear(),
                    month_key: monthKey,
                    gapper_count: gapperCount,
                    total_volume: monthlyAverages[monthKey].total_volume,
                    total_dollar_volume: monthlyAverages[monthKey].total_dollar_volume,
                    avg_open_to_close: avgOTC
                });
            }
            
            // Generate weekly stats
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - (i * 7));
                const year = date.getFullYear();
                const week = Math.floor((date - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000)) + 1;
                
                weeklyStats.push({
                    week_key: `${year}-W${week.toString().padStart(2, '0')}`,
                    avg_open_to_close: (Math.random() - 0.5) * 20
                });
            }
            
            // Generate last gaps
            const tickers = ['WHLR', 'DFLI', 'MITQ', 'AAPL', 'TSLA', 'NVDA', 'AMD', 'PLTR', 'COIN', 'RBLX'];
            for (let i = 0; i < 20; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const ticker = tickers[i % tickers.length];
                const gap = Math.random() * 200 + 45;
                const otc = (Math.random() - 0.5) * 30;
                
                lastGaps.push({
                    ticker: ticker,
                    gapPercentage: gap,
                    volume: Math.floor(Math.random() * 50000000) + 1000000,
                   date: dateStr,
                   openToCloseChange: otc,
                   individualData: {
                       time_labels: timeLabels.slice(0, 20),
                       price_values: avgPrices.slice(0, 20).map(p => 10 + p * 0.1),
                       open: 10,
                       high: 15,
                       low: 8,
                       close: 10 + otc * 0.1
                   }
               });
           }
           
           return {
               monthlyAverages: monthlyAverages,
               monthlyStats: monthlyStats,
               weeklyStats: weeklyStats,
               calendarData: {
                   gap_dates: lastGaps.map(g => g.date),
                   days_since_last_gap: 2
               },
               lastGaps: lastGaps,
               summaryStats: {
                   total_gappers: 1500,
                   avg_gap_percentage: 85.2,
                   avg_open_to_close: -6.8,
                   days_since_last_gap: 2
               },
               totalGappers: 1500
           };
       }

       // Event listeners
       document.addEventListener('DOMContentLoaded', function() {
           // Set up authentication display
           const username = localStorage.getItem('username') || 'User';
           document.getElementById('usernameDisplay').textContent = username;

           // Add event listeners to top chart time filter buttons
           document.querySelectorAll('.time-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   const chartType = this.dataset.chart;
                   const period = this.dataset.period;
                   
                   // Remove active class from buttons in this chart section
                   const section = this.closest('.stat-section');
                   section.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update period for this chart
                   currentTopChartPeriods[chartType] = period;
                   
                   // Recreate the specific chart
                   if (chartType === 'gappers') {
                       createGappersChart();
                   } else if (chartType === 'volume') {
                       createVolumeChart();
                   } else if (chartType === 'dollar') {
                       createDollarVolumeChart();
                   }
               });
           });

           // Add event listeners to bottom chart period buttons
           document.querySelectorAll('.period-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   // Remove active class from all period buttons
                   document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update current period
                   currentBottomPeriod = this.dataset.period;
                   
                   // For now, only M (monthly) is implemented
                   if (currentBottomPeriod === 'M') {
                       createMonthlyAverageCharts();
                   }
                   // TODO: Implement D and W views
               });
           });

           // Close modal when clicking outside
           document.getElementById('chartModal').addEventListener('click', function(e) {
               if (e.target === this) {
                   closeIndividualChart();
               }
           });

           // Close modal with ESC key
           document.addEventListener('keydown', function(e) {
               if (e.key === 'Escape') {
                   closeIndividualChart();
               }
           });

           // Load initial data
           loadData();
       });

       // Window resize handler to refresh charts
       window.addEventListener('resize', function() {
           // Debounce resize events
           clearTimeout(window.resizeTimeout);
           window.resizeTimeout = setTimeout(function() {
               // Refresh all charts
               Object.values(chartInstances).forEach(chart => {
                   if (chart && typeof chart.resize === 'function') {
                       chart.resize();
                   }
               });
           }, 250);
       });
   </script>
</body>
</html>
