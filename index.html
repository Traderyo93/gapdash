<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequitas Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1d2e;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Sidebar Styles */
        .sidebar-nav {
            position: fixed;
            left: 0;
            top: 0;
            width: 60px;
            height: 100vh;
            background: #252836;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 3000;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: #8b8fa3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 18px;
        }

        .nav-item:hover {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
        }

        .nav-item.active {
            background: #4299e1;
            color: white;
        }

        .nav-spacer {
            flex: 1;
        }

        /* Expanded Sidebar */
        .sidebar-expanded {
            position: fixed;
            left: 60px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #1a1d2e;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 2900;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar-expanded.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .aequitas-logo-img {
            max-width: 120px;
            max-height: 40px;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: brightness(1.1) contrast(1.1);
        }

        .sidebar-close {
            background: none;
            border: none;
            color: #8b8fa3;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-section-header {
            color: #4299e1;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 16px 8px 16px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(66, 153, 225, 0.3);
        }

        .menu-section-header:first-child {
            margin-top: 0;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            background: transparent;
            border: none;
            color: #8b8fa3;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s;
        }

        .sidebar-menu-item:hover {
            background: rgba(66, 153, 225, 0.1);
            color: #4299e1;
        }

        .sidebar-menu-item.active {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #8b8fa3;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s;
        }

        .logout-item:hover {
            background: rgba(245, 101, 101, 0.1);
            color: #f56565;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
            margin-left: 80px; /* Account for sidebar */
        }

        /* Top Header */
        .top-header {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .admin-info {
            background: #252836;
            border: 1px solid rgba(66, 153, 225, 0.3);
            color: #4299e1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn {
            background: #4299e1;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #3182ce;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #252836;
            border-radius: 8px;
            align-items: center;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(66, 153, 225, 0.2);
            border-radius: 20px;
            border: 1px solid #4299e1;
        }

        .filter-label {
            color: #a0aec0;
            font-weight: 500;
        }

        .filter-value {
            color: #4299e1;
            font-weight: 600;
        }

        .top-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-section {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
            min-height: 360px; /* Fixed height for consistency */
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .time-filter {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .time-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .time-btn.active {
            background: #4299e1;
        }

        .time-btn:hover {
            background: #5a6578;
        }

        .time-btn.active:hover {
            background: #3182ce;
        }

        .chart-container {
            height: 300px;
            position: relative;
            min-height: 250px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 25px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 25px;
            min-height: 85vh;
        }

        /* Monthly Charts Section */
        .monthly-charts-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .monthly-charts-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .period-selector {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .period-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .period-btn.active {
            background: #4299e1;
        }

        .period-btn:hover {
            background: #5a6578;
        }

        .period-btn.active:hover {
            background: #3182ce;
        }

        .monthly-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .monthly-chart-item {
            background: #1a1d2e;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        .monthly-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 143, 163, 0.2);
            flex-shrink: 0;
        }

        .monthly-chart-title {
            color: #4299e1;
            font-weight: 700;
            font-size: 16px;
        }

        .monthly-chart-stats {
            color: #8b8fa3;
            font-size: 13px;
            text-align: right;
            line-height: 1.4;
        }

        .monthly-chart-container {
            flex: 1;
            position: relative;
            margin-top: 10px;
            min-height: 220px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar-header-card {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day.has-gaps {
            background: #4299e1;
            color: white;
        }

        .calendar-day.no-gaps {
            background: #2d3748;
            color: #8b8fa3;
        }

        .calendar-day.weekend {
            background: #1a1d2e;
            color: #4a5568;
        }

        .calendar-day:hover {
            transform: scale(1.1);
        }

        .date-info {
            text-align: right;
            margin-bottom: 15px;
        }

        .date-info .date {
            color: #4299e1;
            font-weight: 600;
        }

        .date-info .days-since {
            color: #8b8fa3;
            font-size: 12px;
        }

        .gaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .gap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1d2e;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .gap-item:hover {
            background: #2d3748;
        }

        .gap-ticker {
            font-weight: 600;
            color: #ffffff;
        }

        .gap-percentage {
            font-weight: 600;
        }

        .gap-positive {
            color: #48bb78;
        }

        .gap-negative {
            color: #f56565;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b8fa3;
        }

        /* Individual Chart Modal */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .chart-modal-content {
            background: #252836;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-modal-title {
            color: #4299e1;
            font-size: 18px;
            font-weight: 700;
        }

        .chart-modal-close {
            background: none;
            border: none;
            color: #8b8fa3;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .chart-modal-close:hover {
            color: #ffffff;
        }

        .chart-modal-body {
            height: 400px;
            position: relative;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .monthly-charts-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .top-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .monthly-charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-container {
                margin-left: 70px;
                padding: 15px;
            }
        }

        @media (max-width: 900px) {
            .top-stats {
                grid-template-columns: 1fr;
            }

            .monthly-charts-grid {
                grid-template-columns: 1fr;
            }
            
            .monthly-chart-item {
                min-height: 280px;
            }
            
            .monthly-chart-container {
                min-height: 200px;
            }

            .sidebar-nav {
                width: 50px;
            }

            .dashboard-container {
                margin-left: 60px;
                padding: 10px;
            }

            .filter-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .filter-item {
                justify-content: center;
            }
        }

        @media (max-width: 600px) {
            .stat-section {
                min-height: 280px;
                padding: 15px;
            }

            .chart-container {
                height: 220px;
                min-height: 180px;
            }

            .monthly-chart-item {
                min-height: 240px;
                padding: 12px;
            }

            .monthly-chart-container {
                min-height: 160px;
            }

            .dashboard-container {
                margin-left: 50px;
                padding: 8px;
            }
        }

        /* Custom scrollbar */
        .gaps-list::-webkit-scrollbar, .monthly-charts-grid::-webkit-scrollbar {
            width: 6px;
        }

        .gaps-list::-webkit-scrollbar-track, .monthly-charts-grid::-webkit-scrollbar-track {
            background: #1a1d2e;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb, .monthly-charts-grid::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb:hover, .monthly-charts-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }

        /* Chart specific improvements */
        .chart-container canvas {
            max-height: 100% !important;
        }

        .monthly-chart-container canvas {
            max-height: 100% !important;
        }
    </style>
</head>

<body>
    <!-- Navigation Sidebar -->
    <div class="sidebar-nav">
        <button class="nav-item" onclick="toggleSidebar()" title="Menu">
            <span>☰</span>
        </button>
        <div class="nav-spacer"></div>
    </div>

    <!-- Expanded Sidebar -->
    <div class="sidebar-expanded" id="expandedSidebar">
        <div class="sidebar-header">
            <img src="https://i.ibb.co/8DfYwWdG/Aequitas-White-Logo.png" alt="Aequitas Logo" class="aequitas-logo-img">
            <button class="sidebar-close" onclick="closeSidebar()">×</button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- Analytics Section -->
            <div class="menu-section-header">Analytics</div>
            <button class="sidebar-menu-item active" onclick="navigateToPage('gap-analysis')">
                <span>📊</span>
                <span>Gap Analysis</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('market-sentiment')">
                <span>💭</span>
                <span>Market Sentiment</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('scanner')">
                <span>🔍</span>
                <span>Scanner</span>
            </button>
            
            <!-- Code Collaboration Section -->
            <div class="menu-section-header">Code Collaboration</div>
            <button class="sidebar-menu-item" onclick="navigateToPage('file-browser')">
                <span>📁</span>
                <span>File Browser</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('recent-commits')">
                <span>🔄</span>
                <span>Recent Commits</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('pull-requests')">
                <span>🔀</span>
                <span>Pull Requests</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('code-review')">
                <span>👥</span>
                <span>Code Review</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('team-chat')">
                <span>💬</span>
                <span>Team Chat</span>
            </button>
            
            <!-- Strategy Management Section -->
            <div class="menu-section-header">Strategy Management</div>
            <button class="sidebar-menu-item" onclick="navigateToPage('live-strategies')">
                <span>⚡</span>
                <span>Live Strategies</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('performance-metrics')">
                <span>📈</span>
                <span>Performance Metrics</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('deployment-pipeline')">
                <span>🚀</span>
                <span>Deployment Pipeline</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('risk-monitoring')">
                <span>⚠️</span>
                <span>Risk Monitoring</span>
            </button>
            
            <!-- Knowledge Base Section -->
            <div class="menu-section-header">Knowledge Base</div>
            <button class="sidebar-menu-item" onclick="navigateToPage('documentation')">
                <span>📚</span>
                <span>Documentation</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('code-templates')">
                <span>📝</span>
                <span>Code Templates</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('best-practices')">
                <span>✅</span>
                <span>Best Practices</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('post-mortems')">
                <span>🔍</span>
                <span>Post-Mortems</span>
            </button>
            
            <!-- Tools Section -->
            <div class="menu-section-header">Tools</div>
            <button class="sidebar-menu-item" onclick="navigateToPage('calendar')">
                <span>📅</span>
                <span>Calendar</span>
            </button>
            <button class="sidebar-menu-item" onclick="navigateToPage('settings')">
                <span>⚙️</span>
                <span>Settings</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <button class="logout-item" onclick="logout()">
                <span>🚪</span>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Top Header -->
    <div class="top-header">
        <div class="admin-info">
            <span>👤</span>
            <span id="usernameDisplay">admin</span>
        </div>
        <button class="refresh-btn" onclick="loadData()">
            <span>🔄</span>
            <span>Refresh</span>
        </button>
    </div>
    <div class="dashboard-container">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-item">
                <span class="filter-label">Gap value greater than</span>
                <span class="filter-value">50%</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Volume greater than</span>
                <span class="filter-value">1.00 M</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Price greater than</span>
                <span class="filter-value">$0.30</span>
            </div>
        </div>

        <!-- Top Statistics Section -->
        <div class="top-stats">
            <!-- Gappers Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Gappers</span>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="gappers">D</button>
                        <button class="time-btn" data-period="W" data-chart="gappers">W</button>
                        <button class="time-btn active" data-period="M" data-chart="gappers">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gappersChart"></canvas>
                </div>
            </div>

            <!-- Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Volume</span>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="volume">D</button>
                        <button class="time-btn" data-period="W" data-chart="volume">W</button>
                        <button class="time-btn active" data-period="M" data-chart="volume">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Dollar Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>$ volume</span>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="dollar">D</button>
                        <button class="time-btn" data-period="W" data-chart="dollar">W</button>
                        <button class="time-btn active" data-period="M" data-chart="dollar">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dollarVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Period Average Charts -->
                <div class="monthly-charts-card">
                    <div class="monthly-charts-header">
                        <span>Average change from market open (9:30 AM)</span>
                        <div class="period-selector">
                            <button class="period-btn" data-period="D">D</button>
                            <button class="period-btn" data-period="W">W</button>
                            <button class="period-btn active" data-period="M">M</button>
                        </div>
                    </div>
                    <div class="monthly-charts-grid" id="monthlyChartsGrid">
                        <!-- Period average charts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Calendar -->
                <div class="sidebar-card">
                    <div class="date-info">
                        <div class="date" id="currentDate">2025-06-23</div>
                        <div class="days-since" id="daysSince">3 days</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Last Gaps -->
                <div class="sidebar-card">
                    <div class="sidebar-header-card">
                        <span>Recent gaps</span>
                    </div>
                    <div class="gaps-list" id="gapsList">
                        <!-- Gap items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Chart Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <div class="chart-modal-title" id="modalChartTitle">Individual Chart</div>
                <button class="chart-modal-close" onclick="closeIndividualChart()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <canvas id="individualChart"></canvas>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
        Loading dashboard data...
    </div>
    <script>
        // ===== AUTHENTICATION SYSTEM =====
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                // For demo purposes, allow access
                return true;
            }
            
            return true;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }

        // Check authentication immediately
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }

        // ===== SIDEBAR SYSTEM =====
        function toggleSidebar() {
            const sidebar = document.getElementById('expandedSidebar');
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('expandedSidebar');
            sidebar.classList.remove('open');
        }

        function navigateToPage(page) {
            // Remove active from all menu items
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active to clicked item
            event.target.closest('.sidebar-menu-item').classList.add('active');
            
            switch(page) {
                case 'gap-analysis':
                    // Current page - stay here
                    break;
                case 'market-sentiment':
                    showComingSoon('Market Sentiment', 'Real-time sentiment analysis dashboard');
                    break;
                case 'file-browser':
                    showComingSoon('File Browser', 'Navigate through trading scripts and strategies');
                    break;
                case 'recent-commits':
                    showComingSoon('Recent Commits', 'Latest code changes and commit history');
                    break;
                case 'pull-requests':
                    showComingSoon('Pull Requests', 'Code reviews and approvals');
                    break;
                case 'code-review':
                    showComingSoon('Code Review', 'Inline comments and code annotations');
                    break;
                case 'team-chat':
                    showComingSoon('Team Chat', 'Code-specific discussions and strategy debates');
                    break;
                case 'live-strategies':
                    showComingSoon('Live Strategies', 'Running algorithms with P&L tracking');
                    break;
                case 'performance-metrics':
                    showComingSoon('Performance Metrics', 'Backtest results and strategy performance');
                    break;
                case 'deployment-pipeline':
                    showComingSoon('Deployment Pipeline', 'Test → Staging → Production workflow');
                    break;
                case 'risk-monitoring':
                    showComingSoon('Risk Monitoring', 'Real-time strategy risk alerts');
                    break;
                case 'documentation':
                    showComingSoon('Documentation', 'Trading logic and strategy documentation');
                    break;
                case 'code-templates':
                    showComingSoon('Code Templates', 'Standardized patterns for new strategies');
                    break;
                case 'best-practices':
                    showComingSoon('Best Practices', 'Team coding standards and guidelines');
                    break;
                case 'post-mortems':
                    showComingSoon('Post-Mortems', 'Analysis of failed trades and bugs');
                    break;
                default:
                    showComingSoon(page.replace('-', ' ').toUpperCase(), 'Feature coming soon');
            }
        }

        function showComingSoon(title, description) {
            alert(`${title}\n\n${description}\n\nComing soon to the Aequitas platform!`);
        }

        // ===== DASHBOARD CODE =====
        let dashboardData = null;
        let chartInstances = {};
        let currentTopChartPeriods = { gappers: 'M', volume: 'M', dollar: 'M' };
        let currentBottomPeriod = 'M';

        // Improved chart options with better scaling
        const getCommonChartOptions = (yAxisFormatter = null, yAxisSuggestions = {}) => ({
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 300,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: true,
                    grid: { display: false },
                    ticks: { 
                        color: '#8b8fa3',
                        maxTicksLimit: 6,
                        font: { size: 11 }
                    }
                },
                y: {
                    display: true,
                    grid: { color: 'rgba(55, 65, 81, 0.3)' },
                    ticks: { 
                        color: '#8b8fa3',
                        font: { size: 11 },
                        callback: yAxisFormatter || function(value) {
                            return value;
                        }
                    },
                    beginAtZero: true,
                    ...yAxisSuggestions
                }
            },
            elements: {
                point: {
                    radius: 0,
                    hoverRadius: 4
                },
                line: {
                    borderWidth: 2,
                    tension: 0
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        });

        async function loadData() {
            const loadingEl = document.getElementById('loadingIndicator');
            
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('./gap_data_cache.json');
                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                const rawData = await response.json();
                dashboardData = processGapDataCache(rawData);
                updateDashboard();

                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use demo data
                dashboardData = generateDemoData();
                updateDashboard();
                loadingEl.style.display = 'none';
            }
        }

        function processGapDataCache(rawData) {
            console.log('Processing complete gap data cache...');
            console.log(`Found ${rawData.totalGappers} total gappers`);
            console.log(`Monthly averages: ${Object.keys(rawData.monthlyAverages || {}).length}`);
            console.log(`Weekly averages: ${Object.keys(rawData.weeklyAverages || {}).length}`);
            console.log(`Daily averages: ${Object.keys(rawData.dailyAverages || {}).length}`);

            return {
                monthlyAverages: rawData.monthlyAverages || {},
                weeklyAverages: rawData.weeklyAverages || {},
                dailyAverages: rawData.dailyAverages || {},
                monthlyStats: rawData.monthlyStats || [],
                weeklyStats: rawData.weeklyStats || [],
                dailyStats: rawData.dailyStats || [],
                calendarData: rawData.calendarData || {},
                lastGaps: rawData.lastGaps || [],
                summaryStats: rawData.summaryStats || {},
                totalGappers: rawData.totalGappers || 0,
                lastUpdated: rawData.lastUpdated
            };
        }

        function updateDashboard() {
            updateCurrentDate();
            createTopCharts();
            createPeriodAverageCharts();
            createCalendar(dashboardData.calendarData);
            updateLastGaps(dashboardData.lastGaps);
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toISOString().split('T')[0];
            
            const daysSince = dashboardData.calendarData?.days_since_last_gap || 0;
            document.getElementById('daysSince').textContent = `${daysSince} days`;
        }

        function createTopCharts() {
            createGappersChart();
            createVolumeChart();
            createDollarVolumeChart();
        }

        function createGappersChart() {
            const ctx = document.getElementById('gappersChart').getContext('2d');
            
            if (chartInstances.gappersChart && typeof chartInstances.gappersChart.destroy === 'function') {
                chartInstances.gappersChart.destroy();
            }

            const period = currentTopChartPeriods.gappers;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.gapper_count);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.gapper_count);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.gapper_count);
            }

            // Calculate better Y-axis range
            const maxValue = Math.max(...data);
            const suggestedMax = Math.ceil(maxValue * 1.1);

            chartInstances.gappersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    ...getCommonChartOptions(null, { suggestedMax }),
                    scales: {
                        ...getCommonChartOptions().scales,
                        y: {
                            ...getCommonChartOptions().scales.y,
                            suggestedMax,
                            ticks: {
                                ...getCommonChartOptions().scales.y.ticks,
                                stepSize: Math.ceil(maxValue / 5)
                            }
                        }
                    }
                }
            });
        }

        function createVolumeChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            if (chartInstances.volumeChart && typeof chartInstances.volumeChart.destroy === 'function') {
                chartInstances.volumeChart.destroy();
            }

            const period = currentTopChartPeriods.volume;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.total_volume / 1000000);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.total_volume / 1000000);
            }

            const maxValue = Math.max(...data);
            const suggestedMax = Math.ceil(maxValue * 1.1);

            chartInstances.volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    ...getCommonChartOptions(function(value) {
                        return value.toFixed(0) + 'M';
                    }, { suggestedMax }),
                    scales: {
                        ...getCommonChartOptions().scales,
                        y: {
                            ...getCommonChartOptions().scales.y,
                            suggestedMax,
                            ticks: {
                                ...getCommonChartOptions().scales.y.ticks,
                                callback: function(value) {
                                    return value.toFixed(0) + 'M';
                                },
                                stepSize: Math.ceil(maxValue / 5)
                            }
                        }
                    }
                }
            });
        }

        function createDollarVolumeChart() {
            const ctx = document.getElementById('dollarVolumeChart').getContext('2d');
            
            if (chartInstances.dollarVolumeChart && typeof chartInstances.dollarVolumeChart.destroy === 'function') {
                chartInstances.dollarVolumeChart.destroy();
            }

            const period = currentTopChartPeriods.dollar;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_dollar_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.total_dollar_volume / 1000000);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.total_dollar_volume / 1000000);
            }

            const maxValue = Math.max(...data);
            const suggestedMax = Math.ceil(maxValue * 1.1);

            chartInstances.dollarVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    ...getCommonChartOptions(function(value) {
                        return '$' + value.toFixed(0) + 'M';
                    }, { suggestedMax }),
                    scales: {
                        ...getCommonChartOptions().scales,
                        y: {
                            ...getCommonChartOptions().scales.y,
                            suggestedMax,
                            ticks: {
                                ...getCommonChartOptions().scales.y.ticks,
                                callback: function(value) {
                                    return '$' + value.toFixed(0) + 'M';
                                },
                                stepSize: Math.ceil(maxValue / 5)
                            }
                        }
                    }
                }
            });
        }
        function createPeriodAverageCharts() {
            const chartsGrid = document.getElementById('monthlyChartsGrid');
            chartsGrid.innerHTML = '';
            
            // Clear existing chart instances
            Object.keys(chartInstances).forEach(key => {
                if (key.startsWith('period_') && chartInstances[key] && typeof chartInstances[key].destroy === 'function') {
                    chartInstances[key].destroy();
                    delete chartInstances[key];
                }
            });

            let periodData = {};
            let title = '';
            
            if (currentBottomPeriod === 'M') {
                periodData = dashboardData.monthlyAverages;
                title = 'Monthly';
            } else if (currentBottomPeriod === 'W') {
                periodData = dashboardData.weeklyAverages;
                title = 'Weekly';
            } else { // Daily
                periodData = dashboardData.dailyAverages;
                title = 'Daily';
            }
            
            // Sort periods by date (most recent first)
            const sortedPeriods = Object.keys(periodData).sort((a, b) => b.localeCompare(a));
            const periodsToShow = currentBottomPeriod === 'D' ? 12 : (currentBottomPeriod === 'W' ? 12 : 12);
           
           // Create charts for each period
           sortedPeriods.slice(0, periodsToShow).forEach(periodKey => {
               const periodChartData = periodData[periodKey];
               createPeriodChart(periodChartData, periodKey, title);
           });

           if (sortedPeriods.length === 0) {
               chartsGrid.innerHTML = `<div style="text-align: center; color: #8b8fa3; padding: 40px;">No ${title.toLowerCase()} average data available</div>`;
           }
       }

       function createPeriodChart(periodData, periodKey, title) {
           const chartsGrid = document.getElementById('monthlyChartsGrid');
           
           // Create chart container
           const chartItem = document.createElement('div');
           chartItem.className = 'monthly-chart-item';
           
           const chartId = `period_${periodKey.replace(/[-:]/g, '_')}`;
           
           let displayTitle = '';
           if (currentBottomPeriod === 'M') {
               displayTitle = `${periodData.month} ${periodData.year}`;
           } else if (currentBottomPeriod === 'W') {
               displayTitle = `Week ${periodData.week}, ${periodData.year}`;
           } else {
               displayTitle = periodData.day_name;
           }
           
           chartItem.innerHTML = `
               <div class="monthly-chart-header">
                   <div class="monthly-chart-title">${displayTitle}</div>
                   <div class="monthly-chart-stats">
                       <div>${periodData.gapper_count} gappers</div>
                       <div>${periodData.avg_open_to_close > 0 ? '+' : ''}${periodData.avg_open_to_close}% avg</div>
                   </div>
               </div>
               <div class="monthly-chart-container">
                   <canvas id="${chartId}"></canvas>
               </div>
           `;
           
           chartsGrid.appendChild(chartItem);
           
           // Create the actual chart
           setTimeout(() => {
               createPeriodAverageChart(chartId, periodData);
           }, 10);
       }

       function createPeriodAverageChart(chartId, periodData) {
           const ctx = document.getElementById(chartId);
           if (!ctx) return;
           
           const ctxContext = ctx.getContext('2d');
           
           const labels = periodData.time_labels || [];
           const avgPrices = periodData.avg_prices || [];
           
           // Use market-hours-only HOD/LOD percentages from market open
           const hodPct = periodData.avg_high_of_day_pct || 0;  
           const lodPct = periodData.avg_low_of_day_pct || 0;   
           
           // Calculate more realistic Y-axis range based on market hours data
           const maxPrice = Math.max(...avgPrices);
           const minPrice = Math.min(...avgPrices);
           
           // Use dynamic padding for better scaling
           const dataRange = Math.max(Math.abs(hodPct), Math.abs(lodPct), Math.abs(maxPrice), Math.abs(minPrice));
           const padding = Math.max(2, dataRange * 0.15); // 15% padding, minimum 2%
           
           const yMax = Math.max(hodPct, maxPrice) + padding;
           const yMin = Math.min(lodPct, minPrice) - padding;
           
           // Yellow line: Average HOD time (vertical line)
           const avgHODTime = periodData.avg_hod_time || 0.5; // 0-1 scale
           const hodTimeIndex = Math.round(avgHODTime * (labels.length - 1));
           
           // Create vertical line data for HOD time (from bottom to top of chart)
           const hodTimeLine = labels.map((_, index) => {
               if (index === hodTimeIndex) {
                   return yMax; // Extend to top of chart
               }
               return null;
           });
           
           // Reference line at 0% (market open)
           const openLine = new Array(labels.length).fill(0);

           const chart = new Chart(ctxContext, {
               type: 'line',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'Avg HOD Time',
                           data: hodTimeLine,
                           borderColor: '#fbbf24',
                           backgroundColor: 'transparent',
                           borderWidth: 2,
                           pointRadius: 0,
                           tension: 0,
                           spanGaps: false
                       },
                       {
                           label: 'Price Action (from market open)',
                           data: avgPrices,
                           borderColor: '#4299e1',
                           backgroundColor: 'rgba(66, 153, 225, 0.1)',
                           borderWidth: 2,
                           fill: false,
                           pointRadius: 0,
                           pointHoverRadius: 3,
                           tension: 0.2
                       },
                       {
                           label: 'Market Open (0%)',
                           data: openLine,
                           borderColor: '#8b8fa3',
                           backgroundColor: 'transparent',
                           borderWidth: 1,
                           borderDash: [2, 2],
                           pointRadius: 0,
                           tension: 0
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   resizeDelay: 200,
                   interaction: {
                       intersect: false,
                       mode: 'index'
                   },
                   plugins: {
                       legend: { display: false },
                       tooltip: {
                           enabled: true,
                           backgroundColor: 'rgba(37, 40, 54, 0.95)',
                           titleColor: '#ffffff',
                           bodyColor: '#8b8fa3',
                           borderColor: '#4299e1',
                           borderWidth: 1,
                           callbacks: {
                               title: function(context) {
                                   return `${periodData.period_name} - ${context[0].label}`;
                               },
                               label: function(context) {
                                   return `${context.dataset.label}: ${context.parsed.y?.toFixed(1) || 'N/A'}%`;
                               },
                               afterBody: function() {
                                   return [
                                       `Avg HOD % (from market open): ${hodPct.toFixed(1)}%`,
                                       `Avg LOD % (from market open): ${lodPct.toFixed(1)}%`,
                                       `Avg HOD Time: ${periodData.avg_hod_time_str || 'N/A'}`,
                                       `All percentages from market open (9:30 AM)`
                                   ];
                               }
                           }
                       }
                   },
                   scales: {
                       x: {
                           display: true,
                           grid: { display: true, color: 'rgba(139, 143, 163, 0.1)' },
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 4,
                               font: { size: 10 }
                           }
                       },
                       y: {
                           display: true,
                           grid: { color: 'rgba(139, 143, 163, 0.15)' },
                           min: yMin,  // Dynamic minimum
                           max: yMax,  // Dynamic maximum
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 6,
                               font: { size: 10 },
                               callback: function(value) {
                                   return value.toFixed(0) + '%';
                               },
                               stepSize: Math.ceil((yMax - yMin) / 5)
                           }
                       }
                   }
               }
           });
           
           chartInstances[chartId] = chart;
       }

       function createCalendar(calendarData) {
           const calendar = document.getElementById('calendarGrid');
           calendar.innerHTML = '';

           const now = new Date();
           const year = now.getFullYear();
           const month = now.getMonth();
           
           const daysInMonth = new Date(year, month + 1, 0).getDate();
           const firstDay = new Date(year, month, 1).getDay();

           // Get gap dates from real data
           const gapDates = new Set(calendarData?.gap_dates || []);

           // Add empty cells for days before the first day of the month
           for (let i = 0; i < firstDay; i++) {
               const emptyDay = document.createElement('div');
               emptyDay.className = 'calendar-day weekend';
               calendar.appendChild(emptyDay);
           }

           // Add days of the month
           for (let day = 1; day <= daysInMonth; day++) {
               const dayEl = document.createElement('div');
               dayEl.className = 'calendar-day';
               dayEl.textContent = day;

               const dayOfWeek = new Date(year, month, day).getDay();
               const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

               if (dayOfWeek === 0 || dayOfWeek === 6) {
                   dayEl.classList.add('weekend');
               } else {
                   if (gapDates.has(dateString)) {
                       dayEl.classList.add('has-gaps');
                   } else {
                       dayEl.classList.add('no-gaps');
                   }
               }

               calendar.appendChild(dayEl);
           }
       }

       function updateLastGaps(lastGaps) {
           const container = document.getElementById('gapsList');
           container.innerHTML = '';

           lastGaps.slice(0, 25).forEach(gap => {
               const gapItem = document.createElement('div');
               gapItem.className = 'gap-item';
               gapItem.onclick = () => showIndividualChart(gap);

               const isPositive = gap.gapPercentage >= 0;
               const percentageClass = isPositive ? 'gap-positive' : 'gap-negative';
               const otcClass = gap.openToCloseChange >= 0 ? 'gap-positive' : 'gap-negative';

               gapItem.innerHTML = `
                   <div>
                       <div class="gap-ticker">${gap.ticker}</div>
                       <div style="font-size: 11px; color: #8b8fa3;">${formatDate(gap.date)}</div>
                   </div>
                   <div>
                       <div class="gap-percentage ${percentageClass}">${gap.gapPercentage > 0 ? '+' : ''}${gap.gapPercentage.toFixed(1)}%</div>
                       <div class="${otcClass}" style="font-size: 11px; text-align: right;">
                           ${gap.openToCloseChange > 0 ? '+' : ''}${gap.openToCloseChange.toFixed(1)}%
                       </div>
                   </div>
               `;

               container.appendChild(gapItem);
           });
       }

       function showIndividualChart(gapData) {
           const modal = document.getElementById('chartModal');
           const modalTitle = document.getElementById('modalChartTitle');
           
           modalTitle.textContent = `${gapData.ticker} - ${formatDate(gapData.date)} - ${gapData.gapPercentage > 0 ? '+' : ''}${gapData.gapPercentage.toFixed(1)}%`;
           
           modal.style.display = 'flex';
           
           // Clear existing individual chart
           if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
               chartInstances.individualChart.destroy();
           }
           
           // Create individual chart
           setTimeout(() => {
               createIndividualChart(gapData);
           }, 100);
       }

       function createIndividualChart(gapData) {
           const ctx = document.getElementById('individualChart').getContext('2d');
           
           const individualData = gapData.individualData;
           if (!individualData) {
               console.error('No individual chart data available');
               return;
           }

           const labels = individualData.time_labels || [];
           const prices = individualData.price_values || [];
           
           // Calculate proper Y-axis range
           const maxPrice = Math.max(...prices);
           const minPrice = Math.min(...prices);
           const range = maxPrice - minPrice;
           const padding = Math.max(range * 0.1, 2); // 10% padding, minimum 2%
           
           const yMax = maxPrice + padding;
           const yMin = minPrice - padding;
           
           // Create reference lines
           const openLine = new Array(labels.length).fill(0); // Market open at 0%

           chartInstances.individualChart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'Price',
                           data: prices,
                           borderColor: '#4299e1',
                           backgroundColor: 'rgba(66, 153, 225, 0.1)',
                           borderWidth: 3,
                           fill: false,
                           pointRadius: 1,
                           pointHoverRadius: 4,
                           tension: 0.2
                       },
                       {
                           label: 'Market Open',
                           data: openLine,
                           borderColor: '#fbbf24',
                           backgroundColor: 'transparent',
                           borderWidth: 2,
                           borderDash: [3, 3],
                           pointRadius: 0,
                           tension: 0
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   resizeDelay: 200,
                   interaction: {
                       intersect: false,
                       mode: 'index'
                   },
                   plugins: {
                       legend: {
                           display: true,
                           labels: {
                               color: '#8b8fa3',
                               usePointStyle: true,
                               font: { size: 12 }
                           }
                       },
                       tooltip: {
                           enabled: true,
                           backgroundColor: 'rgba(37, 40, 54, 0.95)',
                           titleColor: '#ffffff',
                           bodyColor: '#8b8fa3',
                           borderColor: '#4299e1',
                           borderWidth: 1,
                           callbacks: {
                               title: function(context) {
                                   return `${gapData.ticker} - ${context[0].label}`;
                               },
                               label: function(context) {
                                   return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                               },
                               afterBody: function() {
                                   return 'Market hours data only (9:30 AM - 4:00 PM EST)';
                               }
                           }
                       }
                   },
                   scales: {
                       x: {
                           display: true,
                           grid: {
                               color: 'rgba(139, 143, 163, 0.1)'
                           },
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 8,
                               font: { size: 11 }
                           }
                       },
                       y: {
                           display: true,
                           grid: {
                               color: 'rgba(139, 143, 163, 0.1)'
                           },
                           min: yMin,
                           max: yMax,
                           ticks: {
                               color: '#8b8fa3',
                               font: { size: 11 },
                               callback: function(value) {
                                   return value.toFixed(1) + '%';
                               },
                               stepSize: Math.ceil((yMax - yMin) / 6)
                           }
                       }
                   }
               }
           });
       }

       function closeIndividualChart() {
           const modal = document.getElementById('chartModal');
           modal.style.display = 'none';
           
           if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
               chartInstances.individualChart.destroy();
           }
       }

       function formatDate(dateStr) {
           const date = new Date(dateStr);
           return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }

       function generateDemoData() {
           // Generate demo data matching the expected structure
           const monthlyAverages = {};
           const weeklyAverages = {};
           const dailyAverages = {};
           const monthlyStats = [];
           const weeklyStats = [];
           const dailyStats = [];
           const lastGaps = [];
           
           const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
           const now = new Date();
           
           // Generate last 12 months of data with market hours calculations
           for (let i = 11; i >= 0; i--) {
               const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
               const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
               const monthName = monthNames[date.getMonth()];
               
               // Generate time series for average chart
               const timeLabels = [];
               const avgPrices = [];
               
               // Start with market open
               timeLabels.push('09:30');
               avgPrices.push(0); // Market open = 0%
               
               for (let j = 1; j < 27; j++) {
                   let hour = 9 + Math.floor(j * 0.25);
                   let minute = 30 + ((j * 15) % 60);
                   if (minute >= 60) {
                       hour += 1;
                       minute -= 60;
                   }
                   timeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                   
                   const progress = j / 26;
                   // More realistic market hours price movements starting from 0
                   const baseChange = (Math.random() - 0.3) * 12 * progress; // Gradual movement from 0
                   const volatility = Math.sin(progress * Math.PI) * 3;
                   
                   avgPrices.push(baseChange + (Math.random() - 0.5) * volatility);
               }
               
               const gapperCount = Math.floor(Math.random() * 50) + 20;
               const avgOTC = (Math.random() - 0.5) * 15; // More realistic O-to-C range
               const totalVolume = Math.floor(Math.random() * 100000000) + 50000000;
               const totalDollarVolume = Math.floor(Math.random() * 500000000) + 100000000;
               
               // HOD/LOD calculated from market open (more realistic ranges)
               const avgHodPct = Math.max(...avgPrices) + Math.random() * 5 + 2; // 2-7% above average
               const avgLodPct = Math.min(...avgPrices) - Math.random() * 3 - 1; // 1-4% below average
               
               monthlyAverages[monthKey] = {
                   month: monthName,
                   year: date.getFullYear(),
                   month_key: monthKey,
                   period_name: `${monthName} ${date.getFullYear()}`,
                   gapper_count: gapperCount,
                   avg_gap_percentage: Math.random() * 50 + 60, // 60-110% gap range
                   avg_open_to_close: avgOTC,
                   total_volume: totalVolume,
                   total_dollar_volume: totalDollarVolume,
                   // Realistic HOD/LOD percentages from market open
                   avg_high_of_day_pct: Math.round(avgHodPct * 100) / 100,
                   avg_low_of_day_pct: Math.round(avgLodPct * 100) / 100,
                   avg_hod_time: 0.3 + Math.random() * 0.4, // Between 30-70% of trading day
                   avg_hod_time_str: '11:45', // Sample HOD time
                   time_labels: timeLabels,
                   avg_prices: avgPrices,
                   open_line: new Array(timeLabels.length).fill(0)
               };
               
               monthlyStats.push({
                   month: monthName,
                   year: date.getFullYear(),
                   month_key: monthKey,
                   gapper_count: gapperCount,
                   total_volume: totalVolume,
                   total_dollar_volume: totalDollarVolume,
                   avg_open_to_close: avgOTC
               });
           }
           
           // Generate some demo gap data for recent gaps
           for (let i = 0; i < 20; i++) {
               const date = new Date();
               date.setDate(date.getDate() - i);
               
               const timeLabels = [];
               const priceValues = [];
               
               timeLabels.push('09:30');
               priceValues.push(0);
               
               for (let j = 1; j < 27; j++) {
                   let hour = 9 + Math.floor(j * 0.25);
                   let minute = 30 + ((j * 15) % 60);
                   if (minute >= 60) {
                       hour += 1;
                       minute -= 60;
                   }
                   timeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                   
                   const progress = j / 26;
                   const volatility = Math.sin(progress * Math.PI * 2) * 5;
                   const trend = (Math.random() - 0.6) * 20 * progress;
                   
                   priceValues.push(trend + volatility + (Math.random() - 0.5) * 3);
               }
               
               lastGaps.push({
                   ticker: ['ABCD', 'EFGH', 'IJKL', 'MNOP', 'QRST'][Math.floor(Math.random() * 5)],
                   gapPercentage: 50 + Math.random() * 100,
                   volume: Math.floor(Math.random() * 10000000) + 1000000,
                   date: date.toISOString().split('T')[0],
                   openToCloseChange: (Math.random() - 0.5) * 30,
                   individualData: {
                       time_labels: timeLabels,
                       price_values: priceValues,
                       open: 10 + Math.random() * 5,
                       high: 12 + Math.random() * 8,
                       low: 8 + Math.random() * 3,
                       close: 9 + Math.random() * 6
                   }
               });
           }
           
           return {
               monthlyAverages: monthlyAverages,
               weeklyAverages: {},
               dailyAverages: {},
               monthlyStats: monthlyStats,
               weeklyStats: [],
               dailyStats: [],
               calendarData: {
                   gap_dates: [],
                   days_since_last_gap: 2
               },
               lastGaps: lastGaps,
               summaryStats: {
                   total_gappers: 1500,
                   avg_gap_percentage: 85.2,
                   avg_open_to_close: -6.8,
                   days_since_last_gap: 2
               },
               totalGappers: 1500
           };
       }

       // Enhanced resize handler with debouncing
       function handleResize() {
           clearTimeout(window.resizeTimeout);
           window.resizeTimeout = setTimeout(function() {
               Object.values(chartInstances).forEach(chart => {
                   if (chart && typeof chart.resize === 'function') {
                       try {
                           chart.resize();
                           chart.update('none'); // Update without animation for better performance
                       } catch (e) {
                           console.warn('Chart resize failed:', e);
                       }
                   }
               });
           }, 300);
       }

       // Event listeners
       document.addEventListener('DOMContentLoaded', function() {
           // Set up authentication display
           const username = localStorage.getItem('username') || 'admin';
           document.getElementById('usernameDisplay').textContent = username;

           // Add event listeners to top chart time filter buttons
           document.querySelectorAll('.time-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   const chartType = this.dataset.chart;
                   const period = this.dataset.period;
                   
                   // Remove active class from buttons in this chart section
                   const section = this.closest('.stat-section');
                   section.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update period for this chart
                   currentTopChartPeriods[chartType] = period;
                   
                   // Recreate the specific chart
                   if (chartType === 'gappers') {
                       createGappersChart();
                   } else if (chartType === 'volume') {
                       createVolumeChart();
                   } else if (chartType === 'dollar') {
                       createDollarVolumeChart();
                   }
               });
           });

           // Add event listeners to bottom chart period buttons
           document.querySelectorAll('.period-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   // Remove active class from all period buttons
                   document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update current period
                   currentBottomPeriod = this.dataset.period;
                   
                   // Recreate period charts
                   createPeriodAverageCharts();
               });
           });

           // Close modal when clicking outside
           document.getElementById('chartModal').addEventListener('click', function(e) {
               if (e.target === this) {
                   closeIndividualChart();
               }
           });

           // Close modal with ESC key
           document.addEventListener('keydown', function(e) {
               if (e.key === 'Escape') {
                   closeIndividualChart();
                   closeSidebar();
               }
           });

           // Load initial data
           loadData();
       });

       // Enhanced window resize handler
       window.addEventListener('resize', handleResize);
       
       // Handle orientation change on mobile devices
       window.addEventListener('orientationchange', function() {
           setTimeout(handleResize, 500);
       });
   </script>
</body>
</html>
