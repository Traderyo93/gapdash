<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequitas Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1d2e;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #252836;
            border-radius: 8px;
            align-items: center;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(66, 153, 225, 0.2);
            border-radius: 20px;
            border: 1px solid #4299e1;
        }

        .filter-label {
            color: #a0aec0;
            font-weight: 500;
        }

        .filter-value {
            color: #4299e1;
            font-weight: 600;
        }

        .top-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-section {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .stat-header .info-icon {
            width: 16px;
            height: 16px;
            border: 1px solid #8b8fa3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
        }

        .time-filter {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .time-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .time-btn.active {
            background: #4299e1;
        }

        .time-btn:hover {
            background: #5a6578;
        }

        .time-btn.active:hover {
            background: #3182ce;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 25px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 25px;
            min-height: 85vh;
        }

        /* Monthly Charts Section */
        .monthly-charts-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .monthly-charts-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .period-selector {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .period-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .period-btn.active {
            background: #4299e1;
        }

        .period-btn:hover {
            background: #5a6578;
        }

        .period-btn.active:hover {
            background: #3182ce;
        }

        .monthly-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .monthly-chart-item {
            background: #1a1d2e;
            border-radius: 8px;
            padding: 25px;
            position: relative;
            min-height: 320px;
        }

        .monthly-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 143, 163, 0.2);
        }

        .monthly-chart-title {
            color: #4299e1;
            font-weight: 700;
            font-size: 16px;
        }

        .monthly-chart-stats {
            color: #8b8fa3;
            font-size: 13px;
            text-align: right;
            line-height: 1.4;
        }

        .monthly-chart-container {
            height: 260px;
            position: relative;
            margin-top: 15px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day.has-gaps {
            background: #4299e1;
            color: white;
        }

        .calendar-day.no-gaps {
            background: #2d3748;
            color: #8b8fa3;
        }

        .calendar-day.weekend {
            background: #1a1d2e;
            color: #4a5568;
        }

        .calendar-day:hover {
            transform: scale(1.1);
        }

        .date-info {
            text-align: right;
            margin-bottom: 15px;
        }

        .date-info .date {
            color: #4299e1;
            font-weight: 600;
        }

        .date-info .days-since {
            color: #8b8fa3;
            font-size: 12px;
        }

        .gaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .gap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1d2e;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .gap-item:hover {
            background: #2d3748;
        }

        .gap-ticker {
            font-weight: 600;
            color: #ffffff;
        }

        .gap-percentage {
            font-weight: 600;
        }

        .gap-positive {
            color: #48bb78;
        }

        .gap-negative {
            color: #f56565;
        }

        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4299e1;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn:hover {
            background: #3182ce;
        }

        .logout-section {
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 10px;
            cursor: pointer;
        }

        .logout-section:hover {
            color: #fed7d7;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b8fa3;
        }

        /* Individual Chart Modal */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .chart-modal-content {
            background: #252836;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-modal-title {
            color: #4299e1;
            font-size: 18px;
            font-weight: 700;
        }

        .chart-modal-close {
            background: none;
            border: none;
            color: #8b8fa3;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .chart-modal-close:hover {
            color: #ffffff;
        }

        .chart-modal-body {
            height: 400px;
            position: relative;
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .monthly-charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .top-stats {
                grid-template-columns: 1fr;
            }

            .monthly-charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .monthly-charts-grid {
                grid-template-columns: 1fr;
            }
            
            .monthly-chart-item {
                min-height: 280px;
            }
            
            .monthly-chart-container {
                height: 220px;
            }
        }

        /* Custom scrollbar */
        .gaps-list::-webkit-scrollbar, .monthly-charts-grid::-webkit-scrollbar {
            width: 6px;
        }

        .gaps-list::-webkit-scrollbar-track, .monthly-charts-grid::-webkit-scrollbar-track {
            background: #1a1d2e;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb, .monthly-charts-grid::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb:hover, .monthly-charts-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }
    </style>
</head>

<body>
    <div class="refresh-btn" id="refreshBtn">
        <span onclick="loadData()">ðŸ”„ Refresh</span>
        <span class="logout-section" onclick="logout()">ðŸ‘¤ <span id="usernameDisplay">User</span> | Logout</span>
    </div>

    <div class="dashboard-container">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-item">
                <span class="filter-label">Gap value greater than</span>
                <span class="filter-value">50%</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Volume greater than</span>
                <span class="filter-value">1.00 M</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Price greater than</span>
                <span class="filter-value">$0.30</span>
            </div>
        </div>

        <!-- Top Statistics Section -->
        <div class="top-stats">
            <!-- Gappers Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Gappers</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="gappers">D</button>
                        <button class="time-btn" data-period="W" data-chart="gappers">W</button>
                        <button class="time-btn active" data-period="M" data-chart="gappers">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="gappersChart"></canvas>
                </div>
            </div>

            <!-- Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>Volume</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="volume">D</button>
                        <button class="time-btn" data-period="W" data-chart="volume">W</button>
                        <button class="time-btn active" data-period="M" data-chart="volume">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Dollar Volume Section -->
            <div class="stat-section">
                <div class="stat-header">
                    <span>$ volume</span>
                    <div class="info-icon">?</div>
                    <div class="time-filter">
                        <button class="time-btn" data-period="D" data-chart="dollar">D</button>
                        <button class="time-btn" data-period="W" data-chart="dollar">W</button>
                        <button class="time-btn active" data-period="M" data-chart="dollar">M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="dollarVolumeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Period Average Charts -->
                <div class="monthly-charts-card">
                    <div class="monthly-charts-header">
                        <span>Average change from open</span>
                        <div class="info-icon">?</div>
                        <div class="period-selector">
                            <button class="period-btn" data-period="D">D</button>
                            <button class="period-btn" data-period="W">W</button>
                            <button class="period-btn active" data-period="M">M</button>
                        </div>
                    </div>
                    <div class="monthly-charts-grid" id="monthlyChartsGrid">
                        <!-- Period average charts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Calendar -->
                <div class="sidebar-card">
                    <div class="date-info">
                        <div class="date" id="currentDate">2025-06-23</div>
                        <div class="days-since" id="daysSince">3 days</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Last Gaps -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <span>Recent gaps</span>
                        <div class="info-icon">?</div>
                    </div>
                    <div class="gaps-list" id="gapsList">
                        <!-- Gap items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Chart Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <div class="chart-modal-title" id="modalChartTitle">Individual Chart</div>
                <button class="chart-modal-close" onclick="closeIndividualChart()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <canvas id="individualChart"></canvas>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
        Loading dashboard data...
    </div>

    <script>
        // ===== AUTHENTICATION SYSTEM =====
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                window.location.href = '/login.html';
                return false;
            }
            
            return true;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }

        // Check authentication immediately
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }

        // ===== DASHBOARD CODE =====
        let dashboardData = null;
        let chartInstances = {};
        let currentTopChartPeriods = { gappers: 'M', volume: 'M', dollar: 'M' };
        let currentBottomPeriod = 'M';

        async function loadData() {
            const loadingEl = document.getElementById('loadingIndicator');
            
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('./data/gap_data_cache.json');
                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                const rawData = await response.json();
                dashboardData = processGapDataCache(rawData);
                updateDashboard();

                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use demo data
                dashboardData = generateDemoData();
                updateDashboard();
                loadingEl.style.display = 'none';
            }
        }

        function processGapDataCache(rawData) {
            console.log('Processing complete gap data cache...');
            console.log(`Found ${rawData.totalGappers} total gappers`);
            console.log(`Monthly averages: ${Object.keys(rawData.monthlyAverages || {}).length}`);
            console.log(`Weekly averages: ${Object.keys(rawData.weeklyAverages || {}).length}`);
            console.log(`Daily averages: ${Object.keys(rawData.dailyAverages || {}).length}`);

            return {
                monthlyAverages: rawData.monthlyAverages || {},
                weeklyAverages: rawData.weeklyAverages || {},
                dailyAverages: rawData.dailyAverages || {},
                monthlyStats: rawData.monthlyStats || [],
                weeklyStats: rawData.weeklyStats || [],
                dailyStats: rawData.dailyStats || [],
                calendarData: rawData.calendarData || {},
                lastGaps: rawData.lastGaps || [],
                summaryStats: rawData.summaryStats || {},
                totalGappers: rawData.totalGappers || 0,
                lastUpdated: rawData.lastUpdated
            };
        }

        function updateDashboard() {
            updateCurrentDate();
            createTopCharts();
            createPeriodAverageCharts();
            createCalendar(dashboardData.calendarData);
            updateLastGaps(dashboardData.lastGaps);
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toISOString().split('T')[0];
            
            const daysSince = dashboardData.calendarData?.days_since_last_gap || 0;
            document.getElementById('daysSince').textContent = `${daysSince} days`;
        }

        function createTopCharts() {
            createGappersChart();
            createVolumeChart();
            createDollarVolumeChart();
        }

        function createGappersChart() {
            const ctx = document.getElementById('gappersChart').getContext('2d');
            
            if (chartInstances.gappersChart && typeof chartInstances.gappersChart.destroy === 'function') {
                chartInstances.gappersChart.destroy();
            }

            const period = currentTopChartPeriods.gappers;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.gapper_count);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.gapper_count);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.gapper_count);
            }

            chartInstances.gappersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { color: '#8b8fa3' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createVolumeChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            if (chartInstances.volumeChart && typeof chartInstances.volumeChart.destroy === 'function') {
                chartInstances.volumeChart.destroy();
            }

            const period = currentTopChartPeriods.volume;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.total_volume / 1000000);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.total_volume / 1000000);
            }

            chartInstances.volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#8b8fa3',
                                callback: function(value) {
                                    return value.toFixed(0) + 'M';
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createDollarVolumeChart() {
            const ctx = document.getElementById('dollarVolumeChart').getContext('2d');
            
            if (chartInstances.dollarVolumeChart && typeof chartInstances.dollarVolumeChart.destroy === 'function') {
                chartInstances.dollarVolumeChart.destroy();
            }

            const period = currentTopChartPeriods.dollar;
            let data, labels;

            if (period === 'M') {
                const monthlyData = dashboardData.monthlyStats.slice(-12);
                labels = monthlyData.map(m => `${m.month}-${m.year.toString().slice(-2)}`);
                data = monthlyData.map(m => m.total_dollar_volume / 1000000);
            } else if (period === 'W') {
                const weeklyData = dashboardData.weeklyStats.slice(-12);
                labels = weeklyData.map(w => w.week_key);
                data = weeklyData.map(w => w.total_dollar_volume / 1000000);
            } else { // Daily
                const dailyData = dashboardData.dailyStats.slice(-12);
                labels = dailyData.map(d => d.day_name);
                data = dailyData.map(d => d.total_dollar_volume / 1000000);
            }

            chartInstances.dollarVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#8b8fa3',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#374151' },
                            ticks: { 
                                color: '#8b8fa3',
                                callback: function(value) {
                                    return '$' + value.toFixed(0) + 'M';
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPeriodAverageCharts() {
            const chartsGrid = document.getElementById('monthlyChartsGrid');
            chartsGrid.innerHTML = '';
            
            // Clear existing chart instances
            Object.keys(chartInstances).forEach(key => {
                if (key.startsWith('period_') && chartInstances[key] && typeof chartInstances[key].destroy === 'function') {
                    chartInstances[key].destroy();
                    delete chartInstances[key];
                }
            });

            let periodData = {};
            let title = '';
            
            if (currentBottomPeriod === 'M') {
                periodData = dashboardData.monthlyAverages;
                title = 'Monthly';
            } else if (currentBottomPeriod === 'W') {
                periodData = dashboardData.weeklyAverages;
                title = 'Weekly';
            } else { // Daily
                periodData = dashboardData.dailyAverages;
                title = 'Daily';
            }
            
            // Sort periods by date (most recent first)
            const sortedPeriods = Object.keys(periodData).sort((a, b) => b.localeCompare(a));
           const periodsToShow = currentBottomPeriod === 'D' ? 12 : (currentBottomPeriod === 'W' ? 12 : 12);
           
           // Create charts for each period
           sortedPeriods.slice(0, periodsToShow).forEach(periodKey => {
               const periodChartData = periodData[periodKey];
               createPeriodChart(periodChartData, periodKey, title);
           });

           if (sortedPeriods.length === 0) {
               chartsGrid.innerHTML = `<div style="text-align: center; color: #8b8fa3; padding: 40px;">No ${title.toLowerCase()} average data available</div>`;
           }
       }

       function createPeriodChart(periodData, periodKey, title) {
           const chartsGrid = document.getElementById('monthlyChartsGrid');
           
           // Create chart container
           const chartItem = document.createElement('div');
           chartItem.className = 'monthly-chart-item';
           
           const chartId = `period_${periodKey.replace(/[-:]/g, '_')}`;
           
           let displayTitle = '';
           if (currentBottomPeriod === 'M') {
               displayTitle = `${periodData.month} ${periodData.year}`;
           } else if (currentBottomPeriod === 'W') {
               displayTitle = `Week ${periodData.week}, ${periodData.year}`;
           } else {
               displayTitle = periodData.day_name;
           }
           
           chartItem.innerHTML = `
               <div class="monthly-chart-header">
                   <div class="monthly-chart-title">${displayTitle}</div>
                   <div class="monthly-chart-stats">
                       <div>${periodData.gapper_count} gappers</div>
                       <div>${periodData.avg_open_to_close > 0 ? '+' : ''}${periodData.avg_open_to_close}% avg</div>
                   </div>
               </div>
               <div class="monthly-chart-container">
                   <canvas id="${chartId}"></canvas>
               </div>
           `;
           
           chartsGrid.appendChild(chartItem);
           
           // Create the actual chart
           setTimeout(() => {
               createPeriodAverageChart(chartId, periodData);
           }, 10);
       }

       function createPeriodAverageChart(chartId, periodData) {
           const ctx = document.getElementById(chartId);
           if (!ctx) return;
           
           const ctxContext = ctx.getContext('2d');
           
           const labels = periodData.time_labels || [];
           const avgPrices = periodData.avg_prices || [];
           
           // Use static HOD and LOD from the data (horizontal lines)
           const avgHighOfDay = periodData.avg_high_of_day || 10;
           const avgLowOfDay = periodData.avg_low_of_day || -10;
           
           // Create static horizontal lines
           const hodLine = new Array(labels.length).fill(avgHighOfDay);
           const lodLine = new Array(labels.length).fill(avgLowOfDay);
           const openLine = new Array(labels.length).fill(0); // Reference at 0%

           const chart = new Chart(ctxContext, {
               type: 'line',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'High',
                           data: hodLine,
                           borderColor: '#48bb78',
                           backgroundColor: 'transparent',
                           borderWidth: 3,
                           borderDash: [8, 4],
                           pointRadius: 0,
                           tension: 0
                       },
                       {
                           label: 'Price',
                           data: avgPrices,
                           borderColor: '#4299e1',
                           backgroundColor: 'rgba(66, 153, 225, 0.1)',
                           borderWidth: 3,
                           fill: false,
                           pointRadius: 0,
                           pointHoverRadius: 4,
                           tension: 0.3
                       },
                       {
                           label: 'Open',
                           data: openLine,
                           borderColor: '#fbbf24',
                           backgroundColor: 'transparent',
                           borderWidth: 3,
                           borderDash: [6, 3],
                           pointRadius: 0,
                           tension: 0
                       },
                       {
                           label: 'Low',
                           data: lodLine,
                           borderColor: '#f56565',
                           backgroundColor: 'transparent',
                           borderWidth: 3,
                           borderDash: [8, 4],
                           pointRadius: 0,
                           tension: 0
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   interaction: {
                       intersect: false,
                       mode: 'index'
                   },
                   plugins: {
                       legend: {
                           display: false
                       },
                       tooltip: {
                           enabled: true,
                           backgroundColor: 'rgba(37, 40, 54, 0.95)',
                           titleColor: '#ffffff',
                           bodyColor: '#8b8fa3',
                           borderColor: '#4299e1',
                           borderWidth: 1,
                           displayColors: true,
                           titleFont: { size: 14 },
                           bodyFont: { size: 13 },
                           callbacks: {
                               title: function(context) {
                                   return `${periodData.period_name} - ${context[0].label}`;
                               },
                               label: function(context) {
                                   return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                               }
                           }
                       }
                   },
                   scales: {
                       x: {
                           display: true,
                           grid: {
                               display: true,
                               color: 'rgba(139, 143, 163, 0.1)'
                           },
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 6,
                               font: {
                                   size: 12
                               }
                           }
                       },
                       y: {
                           display: true,
                           grid: {
                               color: 'rgba(139, 143, 163, 0.15)'
                           },
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 6,
                               font: {
                                   size: 12
                               },
                               callback: function(value) {
                                   return value.toFixed(0) + '%';
                               }
                           }
                       }
                   }
               }
           });
           
           chartInstances[chartId] = chart;
       }

       function createCalendar(calendarData) {
           const calendar = document.getElementById('calendarGrid');
           calendar.innerHTML = '';

           const now = new Date();
           const year = now.getFullYear();
           const month = now.getMonth();
           
           const daysInMonth = new Date(year, month + 1, 0).getDate();
           const firstDay = new Date(year, month, 1).getDay();

           // Get gap dates from real data
           const gapDates = new Set(calendarData?.gap_dates || []);

           // Add empty cells for days before the first day of the month
           for (let i = 0; i < firstDay; i++) {
               const emptyDay = document.createElement('div');
               emptyDay.className = 'calendar-day weekend';
               calendar.appendChild(emptyDay);
           }

           // Add days of the month
           for (let day = 1; day <= daysInMonth; day++) {
               const dayEl = document.createElement('div');
               dayEl.className = 'calendar-day';
               dayEl.textContent = day;

               const dayOfWeek = new Date(year, month, day).getDay();
               const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

               if (dayOfWeek === 0 || dayOfWeek === 6) {
                   dayEl.classList.add('weekend');
               } else {
                   if (gapDates.has(dateString)) {
                       dayEl.classList.add('has-gaps');
                   } else {
                       dayEl.classList.add('no-gaps');
                   }
               }

               calendar.appendChild(dayEl);
           }
       }

       function updateLastGaps(lastGaps) {
           const container = document.getElementById('gapsList');
           container.innerHTML = '';

           lastGaps.slice(0, 25).forEach(gap => {
               const gapItem = document.createElement('div');
               gapItem.className = 'gap-item';
               gapItem.onclick = () => showIndividualChart(gap);

               const isPositive = gap.gapPercentage >= 0;
               const percentageClass = isPositive ? 'gap-positive' : 'gap-negative';
               const otcClass = gap.openToCloseChange >= 0 ? 'gap-positive' : 'gap-negative';

               gapItem.innerHTML = `
                   <div>
                       <div class="gap-ticker">${gap.ticker}</div>
                       <div style="font-size: 11px; color: #8b8fa3;">${formatDate(gap.date)}</div>
                   </div>
                   <div>
                       <div class="gap-percentage ${percentageClass}">${gap.gapPercentage > 0 ? '+' : ''}${gap.gapPercentage.toFixed(1)}%</div>
                       <div class="${otcClass}" style="font-size: 11px; text-align: right;">
                           ${gap.openToCloseChange > 0 ? '+' : ''}${gap.openToCloseChange.toFixed(1)}%
                       </div>
                   </div>
               `;

               container.appendChild(gapItem);
           });
       }

       function showIndividualChart(gapData) {
           const modal = document.getElementById('chartModal');
           const modalTitle = document.getElementById('modalChartTitle');
           
           modalTitle.textContent = `${gapData.ticker} - ${formatDate(gapData.date)} - ${gapData.gapPercentage > 0 ? '+' : ''}${gapData.gapPercentage.toFixed(1)}%`;
           
           modal.style.display = 'flex';
           
           // Clear existing individual chart
           if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
               chartInstances.individualChart.destroy();
           }
           
           // Create individual chart
           setTimeout(() => {
               createIndividualChart(gapData);
           }, 100);
       }

       function createIndividualChart(gapData) {
           const ctx = document.getElementById('individualChart').getContext('2d');
           
           const individualData = gapData.individualData;
           if (!individualData) {
               console.error('No individual chart data available');
               return;
           }

           const labels = individualData.time_labels || [];
           const prices = individualData.price_values || [];
           
           // Create reference lines
           const openLine = new Array(labels.length).fill(individualData.open);
           const highLine = new Array(labels.length).fill(individualData.high);
           const lowLine = new Array(labels.length).fill(individualData.low);

           chartInstances.individualChart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: labels,
                   datasets: [
                       {
                           label: 'High',
                           data: highLine,
                           borderColor: '#48bb78',
                           backgroundColor: 'transparent',
                           borderWidth: 2,
                           borderDash: [5, 5],
                           pointRadius: 0,
                           tension: 0
                       },
                       {
                           label: 'Price',
                           data: prices,
                           borderColor: '#4299e1',
                           backgroundColor: 'rgba(66, 153, 225, 0.1)',
                           borderWidth: 3,
                           fill: false,
                           pointRadius: 1,
                           pointHoverRadius: 4,
                           tension: 0.2
                       },
                       {
                           label: 'Open',
                           data: openLine,
                           borderColor: '#fbbf24',
                           backgroundColor: 'transparent',
                           borderWidth: 2,
                           borderDash: [3, 3],
                           pointRadius: 0,
                           tension: 0
                       },
                       {
                           label: 'Low',
                           data: lowLine,
                           borderColor: '#f56565',
                           backgroundColor: 'transparent',
                           borderWidth: 2,
                           borderDash: [5, 5],
                           pointRadius: 0,
                           tension: 0
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   interaction: {
                       intersect: false,
                       mode: 'index'
                   },
                   plugins: {
                       legend: {
                           display: true,
                           labels: {
                               color: '#8b8fa3',
                               usePointStyle: true
                           }
                       },
                       tooltip: {
                           enabled: true,
                           backgroundColor: 'rgba(37, 40, 54, 0.95)',
                           titleColor: '#ffffff',
                           bodyColor: '#8b8fa3',
                           borderColor: '#4299e1',
                           borderWidth: 1,
                           callbacks: {
                               title: function(context) {
                                   return `${gapData.ticker} - ${context[0].label}`;
                               },
                               label: function(context) {
                                   return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                               }
                           }
                       }
                   },
                   scales: {
                       x: {
                           display: true,
                           grid: {
                               color: 'rgba(139, 143, 163, 0.1)'
                           },
                           ticks: {
                               color: '#8b8fa3',
                               maxTicksLimit: 8
                           }
                       },
                       y: {
                           display: true,
                           grid: {
                               color: 'rgba(139, 143, 163, 0.1)'
                           },
                           ticks: {
                               color: '#8b8fa3',
                               callback: function(value) {
                                   return '$' + value.toFixed(2);
                               }
                           }
                       }
                   }
               }
           });
       }

       function closeIndividualChart() {
           const modal = document.getElementById('chartModal');
           modal.style.display = 'none';
           
           if (chartInstances.individualChart && typeof chartInstances.individualChart.destroy === 'function') {
               chartInstances.individualChart.destroy();
           }
       }

       function formatDate(dateStr) {
           const date = new Date(dateStr);
           return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }

       function generateDemoData() {
           // Generate demo data matching the expected structure
           const monthlyAverages = {};
           const weeklyAverages = {};
           const dailyAverages = {};
           const monthlyStats = [];
           const weeklyStats = [];
           const dailyStats = [];
           const lastGaps = [];
           
           const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
           const now = new Date();
           
           // Generate last 12 months of data
           for (let i = 11; i >= 0; i--) {
               const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
               const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
               const monthName = monthNames[date.getMonth()];
               
               // Generate time series for average chart
               const timeLabels = [];
               const avgPrices = [];
               
               for (let j = 0; j < 26; j++) {
                   const hour = 9 + Math.floor(j * 0.25);
                   const minute = 30 + ((j * 15) % 60);
                   timeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                   
                   const progress = j / 25;
                   const baseChange = (Math.random() - 0.5) * 20;
                   const volatility = Math.sin(progress * Math.PI) * 5;
                   
                   avgPrices.push(baseChange + (Math.random() - 0.5) * volatility);
               }
               
               const gapperCount = Math.floor(Math.random() * 50) + 20;
               const avgOTC = (Math.random() - 0.5) * 20;
               const totalVolume = Math.floor(Math.random() * 100000000) + 50000000;
               const totalDollarVolume = Math.floor(Math.random() * 500000000) + 100000000;
               
               monthlyAverages[monthKey] = {
                   month: monthName,
                   year: date.getFullYear(),
                   month_key: monthKey,
                   period_name: `${monthName} ${date.getFullYear()}`,
                   gapper_count: gapperCount,
                   avg_gap_percentage: Math.random() * 100 + 50,
                   avg_open_to_close: avgOTC,
                   total_volume: totalVolume,
                   total_dollar_volume: totalDollarVolume,
                   avg_high_of_day: Math.max(...avgPrices) + 5,
                   avg_low_of_day: Math.min(...avgPrices) - 5,
                   time_labels: timeLabels,
                   avg_prices: avgPrices,
                   open_line: new Array(timeLabels.length).fill(0)
               };
               
               monthlyStats.push({
                   month: monthName,
                   year: date.getFullYear(),
                   month_key: monthKey,
                   gapper_count: gapperCount,
                   total_volume: totalVolume,
                   total_dollar_volume: totalDollarVolume,
                   avg_open_to_close: avgOTC
               });
           }
           
           // Generate weekly and daily demo data
           for (let i = 11; i >= 0; i--) {
               // Weekly
               const weekDate = new Date(now);
               weekDate.setDate(weekDate.getDate() - (i * 7));
               const year = weekDate.getFullYear();
               const week = Math.floor((weekDate - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000)) + 1;
               const weekKey = `${year}-W${week.toString().padStart(2, '0')}`;
               
               const weeklyGapperCount = Math.floor(Math.random() * 20) + 5;
               const weeklyOTC = (Math.random() - 0.5) * 15;
               const weeklyVolume = Math.floor(Math.random() * 30000000) + 10000000;
               const weeklyDollarVolume = Math.floor(Math.random() * 150000000) + 50000000;
               
               const weeklyTimeLabels = [];
               const weeklyAvgPrices = [];
               
               for (let j = 0; j < 26; j++) {
                   const hour = 9 + Math.floor(j * 0.25);
                   const minute = 30 + ((j * 15) % 60);
                   weeklyTimeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                   weeklyAvgPrices.push((Math.random() - 0.5) * 15);
               }
               
               weeklyAverages[weekKey] = {
                   week: week,
                   year: year,
                   week_key: weekKey,
                   period_name: `Week ${week}, ${year}`,
                   gapper_count: weeklyGapperCount,
                   avg_open_to_close: weeklyOTC,
                   total_volume: weeklyVolume,
                   total_dollar_volume: weeklyDollarVolume,
                   avg_high_of_day: Math.max(...weeklyAvgPrices) + 3,
                   avg_low_of_day: Math.min(...weeklyAvgPrices) - 3,
                   time_labels: weeklyTimeLabels,
                   avg_prices: weeklyAvgPrices
               };
               
               weeklyStats.push({
                   week: week,
                   year: year,
                   week_key: weekKey,
                   gapper_count: weeklyGapperCount,
                   total_volume: weeklyVolume,
                   total_dollar_volume: weeklyDollarVolume,
                   avg_open_to_close: weeklyOTC
               });
               
               // Daily
               const dailyDate = new Date(now);
               dailyDate.setDate(dailyDate.getDate() - i);
               const dailyKey = dailyDate.toISOString().split('T')[0];
               const dayName = dailyDate.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
               
               const dailyGapperCount = Math.floor(Math.random() * 10) + 2;
               const dailyOTC = (Math.random() - 0.5) * 20;
               const dailyVolume = Math.floor(Math.random() * 15000000) + 5000000;
               const dailyDollarVolume = Math.floor(Math.random() * 75000000) + 25000000;
               
               const dailyTimeLabels = [];
               const dailyAvgPrices = [];
               
               for (let j = 0; j < 26; j++) {
                   const hour = 9 + Math.floor(j * 0.25);
                   const minute = 30 + ((j * 15) % 60);
                   dailyTimeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                   dailyAvgPrices.push((Math.random() - 0.5) * 12);
               }
               
               dailyAverages[dailyKey] = {
                   date: dailyKey,
                   day_name: dayName,
                   period_name: dayName,
                   gapper_count: dailyGapperCount,
                   avg_open_to_close: dailyOTC,
                   total_volume: dailyVolume,
                   total_dollar_volume: dailyDollarVolume,
                   avg_high_of_day: Math.max(...dailyAvgPrices) + 2,
                   avg_low_of_day: Math.min(...dailyAvgPrices) - 2,
                   time_labels: dailyTimeLabels,
                   avg_prices: dailyAvgPrices
               };
               
               dailyStats.push({
                   date: dailyKey,
                   day_name: dayName,
                   gapper_count: dailyGapperCount,
                   total_volume: dailyVolume,
                   total_dollar_volume: dailyDollarVolume,
                   avg_open_to_close: dailyOTC
               });
           }
           
           // Generate last gaps
           const tickers = ['WHLR', 'DFLI', 'MITQ', 'AAPL', 'TSLA', 'NVDA', 'AMD', 'PLTR', 'COIN', 'RBLX'];
           for (let i = 0; i < 20; i++) {
               const date = new Date(now);
               date.setDate(date.getDate() - i);
               const dateStr = date.toISOString().split('T')[0];
               
               const ticker = tickers[i % tickers.length];
               const gap = Math.random() * 200 + 50;
               const otc = (Math.random() - 0.5) * 30;
               
               const timeLabels = [];
               for (let j = 0; j < 20; j++) {
                   const hour = 9 + Math.floor(j * 0.33);
                   const minute = 30 + ((j * 20) % 60);
                   timeLabels.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
               }
               
               lastGaps.push({
                   ticker: ticker,
                   gapPercentage: gap,
                   volume: Math.floor(Math.random() * 50000000) + 1000000,
                   date: dateStr,
                   openToCloseChange: otc,
                   individualData: {
                       time_labels: timeLabels,
                       price_values: timeLabels.map(() => 10 + Math.random() * 5),
                       open: 10,
                       high: 15,
                       low: 8,
                       close: 10 + otc * 0.1
                   }
               });
           }
           
           return {
               monthlyAverages: monthlyAverages,
               weeklyAverages: weeklyAverages,
               dailyAverages: dailyAverages,
               monthlyStats: monthlyStats,
               weeklyStats: weeklyStats,
               dailyStats: dailyStats,
               calendarData: {
                   gap_dates: lastGaps.map(g => g.date),
                   days_since_last_gap: 2
               },
               lastGaps: lastGaps,
               summaryStats: {
                   total_gappers: 1500,
                   avg_gap_percentage: 85.2,
                   avg_open_to_close: -6.8,
                   days_since_last_gap: 2
               },
               totalGappers: 1500
           };
       }

       // Event listeners
       document.addEventListener('DOMContentLoaded', function() {
           // Set up authentication display
           const username = localStorage.getItem('username') || 'User';
           document.getElementById('usernameDisplay').textContent = username;

           // Add event listeners to top chart time filter buttons
           document.querySelectorAll('.time-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   const chartType = this.dataset.chart;
                   const period = this.dataset.period;
                   
                   // Remove active class from buttons in this chart section
                   const section = this.closest('.stat-section');
                   section.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update period for this chart
                   currentTopChartPeriods[chartType] = period;
                   
                   // Recreate the specific chart
                   if (chartType === 'gappers') {
                       createGappersChart();
                   } else if (chartType === 'volume') {
                       createVolumeChart();
                   } else if (chartType === 'dollar') {
                       createDollarVolumeChart();
                   }
               });
           });

           // Add event listeners to bottom chart period buttons
           document.querySelectorAll('.period-btn').forEach(btn => {
               btn.addEventListener('click', function() {
                   // Remove active class from all period buttons
                   document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                   
                   // Add active class to clicked button
                   this.classList.add('active');
                   
                   // Update current period
                   currentBottomPeriod = this.dataset.period;
                   
                   // Recreate period charts
                   createPeriodAverageCharts();
               });
           });

           // Close modal when clicking outside
           document.getElementById('chartModal').addEventListener('click', function(e) {
               if (e.target === this) {
                   closeIndividualChart();
               }
           });

           // Close modal with ESC key
           document.addEventListener('keydown', function(e) {
               if (e.key === 'Escape') {
                   closeIndividualChart();
               }
           });

           // Load initial data
           loadData();
       });

       // Window resize handler to refresh charts
       window.addEventListener('resize', function() {
           clearTimeout(window.resizeTimeout);
           window.resizeTimeout = setTimeout(function() {
               Object.values(chartInstances).forEach(chart => {
                   if (chart && typeof chart.resize === 'function') {
                       chart.resize();
                   }
               });
           }, 250);
       });
   </script>
</body>
</html>
                                                               
