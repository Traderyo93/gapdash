<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequitas Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1d2e;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .dashboard-container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #252836;
            border-radius: 8px;
            align-items: center;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(66, 153, 225, 0.2);
            border-radius: 20px;
            border: 1px solid #4299e1;
        }

        .filter-label {
            color: #a0aec0;
            font-weight: 500;
        }

        .filter-value {
            color: #4299e1;
            font-weight: 600;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .charts-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        /* Period Controls */
        .period-controls {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .period-title {
            color: #8b8fa3;
            font-size: 16px;
            font-weight: 600;
        }

        .period-toggles {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            background: #4a5568;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn.active {
            background: #4299e1;
            transform: translateY(-1px);
        }

        .period-btn:hover {
            background: #5a6578;
        }

        .period-btn.active:hover {
            background: #3182ce;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            background: #252836;
            border-radius: 8px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .chart-item {
            background: #1a1d2e;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-ticker {
            color: #4299e1;
            font-weight: 700;
            font-size: 14px;
        }

        .chart-gap {
            color: #48bb78;
            font-weight: 600;
            font-size: 12px;
        }

        .chart-gap.negative {
            color: #f56565;
        }

        .chart-date {
            color: #8b8fa3;
            font-size: 11px;
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .mini-chart {
            height: 120px;
            position: relative;
        }

        .chart-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #8b8fa3;
        }

        .chart-stat {
            text-align: center;
        }

        .chart-stat-value {
            color: #ffffff;
            font-weight: 600;
        }

        .chart-stat-label {
            color: #8b8fa3;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: #252836;
            border-radius: 8px;
            padding: 20px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #8b8fa3;
            font-size: 13px;
            font-weight: 500;
        }

        .gaps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .gap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1a1d2e;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .gap-item:hover {
            background: #2d3748;
        }

        .gap-ticker {
            font-weight: 600;
            color: #ffffff;
        }

        .gap-percentage {
            font-weight: 600;
        }

        .gap-positive {
            color: #48bb78;
        }

        .gap-negative {
            color: #f56565;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: #1a1d2e;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            color: #4299e1;
            font-size: 18px;
            font-weight: 700;
        }

        .stat-label {
            color: #8b8fa3;
            font-size: 12px;
            margin-top: 5px;
        }

        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4299e1;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn:hover {
            background: #3182ce;
        }

        .logout-section {
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 10px;
            cursor: pointer;
        }

        .logout-section:hover {
            color: #fed7d7;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b8fa3;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        /* Custom scrollbar */
        .gaps-list::-webkit-scrollbar, .charts-grid::-webkit-scrollbar {
            width: 6px;
        }

        .gaps-list::-webkit-scrollbar-track, .charts-grid::-webkit-scrollbar-track {
            background: #1a1d2e;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb, .charts-grid::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .gaps-list::-webkit-scrollbar-thumb:hover, .charts-grid::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }
    </style>
</head>

<body>
    <div class="refresh-btn" id="refreshBtn">
        <span onclick="loadData()">ðŸ”„ Refresh</span>
        <span class="logout-section" onclick="logout()">ðŸ‘¤ <span id="usernameDisplay">User</span> | Logout</span>
    </div>

    <div class="dashboard-container">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-item">
                <span class="filter-label">Gap value between</span>
                <span class="filter-value">45% and 1000%</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Volume greater than</span>
                <span class="filter-value">1.00 M</span>
            </div>
            <div class="filter-item">
                <span class="filter-label">Price greater than</span>
                <span class="filter-value">$0.30</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Period Controls -->
                <div class="period-controls">
                    <div class="period-title">Average change from open</div>
                    <div class="period-toggles">
                        <button class="period-btn active" data-period="D">D</button>
                        <button class="period-btn" data-period="W">W</button>
                        <button class="period-btn" data-period="M">M</button>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid" id="chartsGrid">
                    <!-- Individual charts will be populated here -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Summary Stats -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <span>Summary</span>
                    </div>
                    <div class="summary-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalGappers">0</div>
                            <div class="stat-label">Total Gappers</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgGap">0%</div>
                            <div class="stat-label">Avg Gap</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgOTC">0%</div>
                            <div class="stat-label">Avg O-to-C</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="daysSince">0</div>
                            <div class="stat-label">Days Since</div>
                        </div>
                    </div>
                </div>

                <!-- Last Gaps -->
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <span>Recent gaps</span>
                    </div>
                    <div class="gaps-list" id="gapsList">
                        <!-- Gap items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
        Loading intraday data...
    </div>
    <script>
        // ===== AUTHENTICATION SYSTEM =====
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                window.location.href = '/login.html';
                return false;
            }
            
            return true;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }

        // Check authentication immediately
        if (!checkAuthentication()) {
            throw new Error('Authentication required');
        }

        // ===== DASHBOARD CODE =====
        let dashboardData = null;
        let currentPeriod = 'D';
        let chartInstances = {};

        async function loadData() {
            const loadingEl = document.getElementById('loadingIndicator');
            
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('./data/gap_data_cache.json');
                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                const rawData = await response.json();
                dashboardData = processGapDataCache(rawData);
                updateDashboard();

                loadingEl.style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use demo data
                dashboardData = generateDemoData();
                updateDashboard();
                loadingEl.style.display = 'none';
            }
        }

        function processGapDataCache(rawData) {
            console.log('Processing intraday gap data cache...');
            
            return {
                timePeriodsData: rawData.timePeriodsData || { daily: {}, weekly: {}, monthly: {} },
                summaryStats: rawData.summaryStats || {},
                lastGaps: rawData.lastGaps || [],
                totalGappers: rawData.totalGappers || 0,
                lastUpdated: rawData.lastUpdated
            };
        }

        function updateDashboard() {
            updateSummaryStats();
            updateChartsForPeriod(currentPeriod);
            updateLastGaps();
        }

        function updateSummaryStats() {
            const stats = dashboardData.summaryStats;
            
            document.getElementById('totalGappers').textContent = stats.total_gappers || 0;
            document.getElementById('avgGap').textContent = `${stats.avg_gap_percentage || 0}%`;
            document.getElementById('avgOTC').textContent = `${stats.avg_open_to_close || 0}%`;
            document.getElementById('daysSince').textContent = stats.days_since_last_gap || 0;
        }

        function updateChartsForPeriod(period) {
            const chartsGrid = document.getElementById('chartsGrid');
            chartsGrid.innerHTML = '';
            
            // Clear existing chart instances
            Object.values(chartInstances).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            chartInstances = {};

            let periodData = {};
            switch(period) {
                case 'D':
                    periodData = dashboardData.timePeriodsData.daily || {};
                    break;
                case 'W':
                    periodData = dashboardData.timePeriodsData.weekly || {};
                    break;
                case 'M':
                    periodData = dashboardData.timePeriodsData.monthly || {};
                    break;
            }

            // Sort periods by date (most recent first)
            const sortedPeriods = Object.keys(periodData).sort((a, b) => b.localeCompare(a));
            
            // Create charts for each period
            sortedPeriods.slice(0, 20).forEach(periodKey => {
                const gappers = periodData[periodKey];
                if (gappers && gappers.length > 0) {
                    gappers.forEach(gapper => {
                        createMiniChart(gapper, period);
                    });
                }
            });

            if (sortedPeriods.length === 0) {
                chartsGrid.innerHTML = '<div style="text-align: center; color: #8b8fa3; padding: 40px;">No data available for this period</div>';
            }
        }

        function createMiniChart(gapper, period) {
            const chartsGrid = document.getElementById('chartsGrid');
            
            // Create chart container
            const chartItem = document.createElement('div');
            chartItem.className = 'chart-item';
            
            const chartId = `chart_${gapper.ticker}_${gapper.date.replace(/-/g, '')}`;
            
            chartItem.innerHTML = `
                <div class="chart-header">
                    <div class="chart-ticker">${gapper.ticker}</div>
                    <div class="chart-gap ${gapper.gap_percentage >= 0 ? '' : 'negative'}">
                        ${gapper.gap_percentage > 0 ? '+' : ''}${gapper.gap_percentage.toFixed(1)}%
                    </div>
                </div>
                <div class="chart-date">${formatDate(gapper.date)}</div>
                <div class="mini-chart">
                    <canvas id="${chartId}"></canvas>
                </div>
                <div class="chart-stats">
                    <div class="chart-stat">
                        <div class="chart-stat-value">$${gapper.high.toFixed(2)}</div>
                        <div class="chart-stat-label">HIGH</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value">$${gapper.open.toFixed(2)}</div>
                        <div class="chart-stat-label">OPEN</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value">$${gapper.low.toFixed(2)}</div>
                        <div class="chart-stat-label">LOW</div>
                    </div>
                    <div class="chart-stat">
                        <div class="chart-stat-value ${gapper.open_to_close_change >= 0 ? 'gap-positive' : 'gap-negative'}">
                            ${gapper.open_to_close_change > 0 ? '+' : ''}${gapper.open_to_close_change.toFixed(1)}%
                        </div>
                        <div class="chart-stat-label">O-to-C</div>
                    </div>
                </div>
            `;
            
            chartsGrid.appendChild(chartItem);
            
            // Create the actual chart
            setTimeout(() => {
                createIntradayChart(chartId, gapper);
            }, 10);
        }

        function createIntradayChart(chartId, gapper) {
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            
            const ctxContext = ctx.getContext('2d');
            
            // Prepare chart data
            const labels = gapper.times || [];
            const prices = gapper.prices || [];
            
            // Create reference lines data
            const openLine = new Array(labels.length).fill(gapper.open);
            const highLine = new Array(labels.length).fill(gapper.high);
            const lowLine = new Array(labels.length).fill(gapper.low);
            
            const chart = new Chart(ctxContext, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'High',
                            data: highLine,
                            borderColor: '#48bb78',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Price',
                            data: prices,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 3,
                            tension: 0.2
                        },
                        {
                            label: 'Open',
                            data: openLine,
                            borderColor: '#fbbf24',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Low',
                            data: lowLine,
                            borderColor: '#f56565',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(37, 40, 54, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8b8fa3',
                            borderColor: '#4299e1',
                            borderWidth: 1,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return `${gapper.ticker} - ${context[0].label}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#8b8fa3',
                                maxTicksLimit: 6,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(139, 143, 163, 0.1)'
                            },
                            ticks: {
                                color: '#8b8fa3',
                                maxTicksLimit: 5,
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            
            // Store chart instance for cleanup
            chartInstances[chartId] = chart;
        }

        function updateLastGaps() {
            const container = document.getElementById('gapsList');
            container.innerHTML = '';

            dashboardData.lastGaps.slice(0, 25).forEach(gap => {
                const gapItem = document.createElement('div');
                gapItem.className = 'gap-item';

                const isPositive = gap.gapPercentage >= 0;
                const percentageClass = isPositive ? 'gap-positive' : 'gap-negative';

                gapItem.innerHTML = `
                    <div>
                        <div class="gap-ticker">${gap.ticker}</div>
                        <div style="font-size: 11px; color: #8b8fa3;">${formatDate(gap.date)}</div>
                    </div>
                    <div>
                        <div class="gap-percentage ${percentageClass}">${gap.gapPercentage > 0 ? '+' : ''}${gap.gapPercentage.toFixed(1)}%</div>
                        <div style="font-size: 11px; color: #8b8fa3; text-align: right;">
                            ${gap.openToCloseChange > 0 ? '+' : ''}${gap.openToCloseChange.toFixed(1)}%
                        </div>
                    </div>
                `;

                container.appendChild(gapItem);
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function generateDemoData() {
            // Generate demo intraday data
            const demoData = {
                timePeriodsData: {
                    daily: {},
                    weekly: {},
                    monthly: {}
                },
                summaryStats: {
                    total_gappers: 156,
                    avg_gap_percentage: 78.5,
                    avg_open_to_close: -8.2,
                    days_since_last_gap: 2
                },
                lastGaps: [],
                totalGappers: 156
            };

            // Create demo charts for last 10 days
            const tickers = ['WHLR', 'DFLI', 'MITQ', 'AAPL', 'TSLA', 'NVDA', 'AMD', 'PLTR', 'COIN', 'RBLX'];
            const today = new Date();
            
            for (let i = 0; i < 10; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const ticker = tickers[i % tickers.length];
                const open = 10 + Math.random() * 50;
                const gap = 50 + Math.random() * 100;
                const high = open * (1 + (gap + Math.random() * 20) / 100);
                const low = open * (0.8 + Math.random() * 0.15);
                const close = low + Math.random() * (high - low);
                
                // Generate 15-minute intervals
                const times = [];
                const prices = [];
                const startHour = 9;
                const startMin = 30;
                
                for (let j = 0; j < 26; j++) { // 6.5 hours * 4 intervals per hour
                    const totalMins = j * 15;
                    const hour = startHour + Math.floor(totalMins / 60);
                    const min = (startMin + (totalMins % 60)) % 60;
                    times.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
                    
                    // Generate realistic price movement
                    const progress = j / 25;
                    const volatility = 0.05 + Math.random() * 0.1;
                    let price = open + (close - open) * progress + (Math.random() - 0.5) * open * volatility;
                    price = Math.max(low, Math.min(high, price));
                    prices.push(price);
                }
                
                const gapper = {
                    ticker: ticker,
                    date: dateStr,
                    gap_percentage: gap,
                    times: times,
                    prices: prices,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    open_to_close_change: ((close - open) / open) * 100,
                    total_volume: Math.floor(Math.random() * 50000000) + 1000000
                };
                
                demoData.timePeriodsData.daily[dateStr] = [gapper];
                demoData.lastGaps.push({
                    ticker: ticker,
                    gapPercentage: gap,
                    volume: gapper.total_volume,
                    date: dateStr,
                    openToCloseChange: gapper.open_to_close_change
                });
            }
            
            return demoData;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Set up authentication display
            const username = localStorage.getItem('username') || 'User';
            document.getElementById('usernameDisplay').textContent = username;

            // Add event listeners to period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update current period and refresh charts
                    currentPeriod = this.dataset.period;
                    updateChartsForPeriod(currentPeriod);
                });
            });

            // Load initial data
            loadData();
        });
    </script>
</body>
</html>
